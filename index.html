<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AFSNote</title>
    <link rel="icon" type="image/x-icon" href="https://busland.neocities.org/hobopad.ico">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* iOS Light */
            --ios-light-bg: #ffffff;
            --ios-light-surface: #f2f2f7;
            --ios-light-text: #000000;
            --ios-light-secondary: #8e8e93;
            --ios-light-accent: #007aff;
            --ios-light-border: #c6c6c8;
            --ios-light-header: #f9f9f9;
            
            /* iOS Dark */
            --ios-dark-bg: #000000;
            --ios-dark-surface: #1c1c1e;
            --ios-dark-text: #ffffff;
            --ios-dark-secondary: #8e8e93;
            --ios-dark-accent: #0a84ff;
            --ios-dark-border: #38383a;
            --ios-dark-header: #1c1c1e;
            
            /* Android Light */
            --android-light-bg: #ffffff;
            --android-light-surface: #f5f5f5;
            --android-light-text: #000000;
            --android-light-secondary: #666666;
            --android-light-accent: #1976d2;
            --android-light-border: #e0e0e0;
            --android-light-header: #fafafa;
            
            /* Android Dark */
            --android-dark-bg: #121212;
            --android-dark-surface: #1e1e1e;
            --android-dark-text: #ffffff;
            --android-dark-secondary: #b0b0b0;
            --android-dark-accent: #8ab4f8;
            --android-dark-border: #333333;
            --android-dark-header: #1e1e1e;
        }

        body {
            font-family: 'Atkinson Hyperlegible', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* iOS Light Theme */
        .ios-light {
            --bg: var(--ios-light-bg);
            --surface: var(--ios-light-surface);
            --text: var(--ios-light-text);
            --secondary: var(--ios-light-secondary);
            --accent: var(--ios-light-accent);
            --border: var(--ios-light-border);
            --header: var(--ios-light-header);
        }

        /* iOS Dark Theme */
        .ios-dark {
            --bg: var(--ios-dark-bg);
            --surface: var(--ios-dark-surface);
            --text: var(--ios-dark-text);
            --secondary: var(--ios-dark-secondary);
            --accent: var(--ios-dark-accent);
            --border: var(--ios-dark-border);
            --header: var(--ios-dark-header);
        }

        /* Android Light Theme */
        .android-light {
            --bg: var(--android-light-bg);
            --surface: var(--android-light-surface);
            --text: var(--android-light-text);
            --secondary: var(--android-light-secondary);
            --accent: var(--android-light-accent);
            --border: var(--android-light-border);
            --header: var(--android-light-header);
        }

        /* Android Dark Theme */
        .android-dark {
            --bg: var(--android-dark-bg);
            --surface: var(--android-dark-surface);
            --text: var(--android-dark-text);
            --secondary: var(--android-dark-secondary);
            --accent: var(--android-dark-accent);
            --border: var(--android-dark-border);
            --header: var(--android-dark-header);
        }

        #app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--bg);
        }

        /* Header */
        .header {
            background: var(--header);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            flex: 1;
            text-align: center;
        }

        /* Menu Bar */
        .menu-bar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 8px 16px;
            flex-shrink: 0;
        }

        .menu-button {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--accent);
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .android-light .menu-button,
        .android-dark .menu-button {
            border-radius: 20px;
        }

        .menu-button:hover {
            background: var(--border);
        }

        .menu-button:active {
            transform: scale(0.98);
        }

        /* Dropdown Menu */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            z-index: 1000;
            top: 100%;
            margin-top: 4px;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            color: var(--text);
            border-bottom: 1px solid var(--border);
            transition: background 0.2s;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--border);
        }

        /* Editor Container */
        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #editor {
            flex: 1;
            padding: 16px;
            background: var(--bg);
            color: var(--text);
            border: none;
            outline: none;
            resize: none;
            font-size: 16px;
            line-height: 1.7;
            font-family: 'Atkinson Hyperlegible', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        /* Checklist Container */
        #checklist-container {
            display: none;
            flex: 1;
            flex-direction: column;
            padding: 16px;
            overflow-y: auto;
        }

        #checklist-container.active {
            display: flex;
        }

        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            padding: 12px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            gap: 12px;
            position: relative;
            transition: all 0.3s ease;
        }

        .android-light .checklist-item,
        .android-dark .checklist-item {
            border-radius: 12px;
        }

        .checklist-item.completed {
            opacity: 0.6;
        }

        .checklist-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: var(--accent);
        }

        .checklist-text {
            flex: 1;
            color: var(--text);
            word-break: break-word;
            cursor: text;
            line-height: 1.6;
        }

        .checklist-item.completed .checklist-text {
            text-decoration: line-through;
        }

        .checklist-edit-input {
            flex: 1;
            padding: 8px;
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--accent);
            border-radius: 6px;
            font-size: 16px;
            outline: none;
            display: none;
        }

        .checklist-item.editing .checklist-edit-input {
            display: block;
        }

        .checklist-item.editing .checklist-text {
            display: none;
        }

        .checklist-delete {
            position: absolute;
            right: -100%;
            background: #ff3b30;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: right 0.3s ease;
            font-weight: 500;
        }

        .checklist-delete.show {
            right: 8px;
        }

        .checklist-input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        #checklist-input {
            flex: 1;
            padding: 12px;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .android-light #checklist-input,
        .android-dark #checklist-input {
            border-radius: 24px;
        }

        #checklist-input:focus {
            border-color: var(--accent);
        }

        .checklist-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .android-light .btn-primary,
        .android-dark .btn-primary {
            border-radius: 20px;
        }

        .btn-primary:hover {
            opacity: 0.9;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 18px;
            color: var(--text);
        }

        .modal-body {
            padding: 16px;
        }

        .modal-body p {
            color: var(--text);
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 500;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
        }

        .form-input:focus,
        .form-select:focus {
            border-color: var(--accent);
        }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-secondary:active {
            transform: scale(0.98);
        }

        /* File Manager */
        #file-manager {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg);
            z-index: 1500;
            flex-direction: column;
        }

        #file-manager.show {
            display: flex;
        }

        .file-manager-header {
            background: var(--header);
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-button {
            background: transparent;
            border: none;
            color: var(--accent);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 500;
        }

        .file-manager-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }

        .file-manager-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .notes-list-panel {
            width: 40%;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        .notes-list-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
        }

        .note-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
        }

        .note-item:hover {
            background: var(--surface);
        }

        .note-item.active {
            background: var(--accent);
            color: white;
        }

        .note-item-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .note-item-date {
            font-size: 12px;
            color: var(--secondary);
        }

        .note-item.active .note-item-date {
            color: rgba(255, 255, 255, 0.8);
        }

        .preview-panel {
            width: 60%;
            display: flex;
            flex-direction: column;
        }

        .preview-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            background: var(--surface);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .preview-info {
            flex: 1;
            min-width: 0;
        }

        .preview-title {
            font-weight: 600;
            font-size: 18px;
            margin-bottom: 4px;
            color: var(--text);
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .preview-date {
            font-size: 12px;
            color: var(--secondary);
            margin-bottom: 12px;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .preview-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            white-space: pre-wrap;
            color: var(--text);
            line-height: 1.7;
        }

        /* IO Section */
        .io-section {
            display: flex;
            justify-content: space-around;
            padding: 20px 0;
        }

        .io-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 16px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .io-button:hover {
            background: var(--surface);
        }

        .io-icon {
            font-size: 48px;
        }

        .io-label {
            font-size: 14px;
            color: var(--text);
        }

        .io-warning {
            text-align: center;
            color: var(--secondary);
            font-size: 12px;
            padding: 0 16px 16px;
        }

        /* Hidden file inputs */
        input[type="file"] {
            display: none;
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--surface);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Resize Handle */
        .resize-handle {
            display: none;
            height: 8px;
            background: var(--border);
            cursor: row-resize;
            position: relative;
            z-index: 10;
            flex-shrink: 0;
            touch-action: none;
            transition: background 0.2s;
        }

        .resize-handle:hover {
            background: var(--accent);
            opacity: 0.7;
        }

        .resize-handle:active {
            background: var(--accent);
            opacity: 1;
        }

        .resize-handle.dragging {
            background: var(--accent);
            opacity: 1;
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 0;
            right: 0;
            height: 24px;
        }

        .resize-handle::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 4px;
            background: currentColor;
            opacity: 0.5;
            border-radius: 2px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .menu-bar {
                gap: 4px;
                padding: 6px 12px;
            }

            .menu-button {
                padding: 4px 12px;
                font-size: 13px;
            }

            .file-manager-content {
                flex-direction: column;
            }

            .notes-list-panel {
                width: 100%;
                height: 40%;
                min-height: 100px;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }

            .resize-handle {
                display: block;
            }

            .preview-panel {
                width: 100%;
                height: 60%;
                min-height: 100px;
                display: flex;
            }

            .preview-header {
                padding: 12px 16px;
                flex-wrap: nowrap;
            }

            .preview-info {
                flex: 1;
                min-width: 0;
            }

            .preview-title {
                font-size: 16px;
                font-weight: 600;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-bottom: 2px;
            }

            .preview-date {
                font-size: 12px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .preview-actions {
                display: flex;
                gap: 8px;
                flex-shrink: 0;
            }

            .preview-actions button {
                padding: 8px 16px;
                font-size: 14px;
                white-space: nowrap;
            }

            #delete-note-btn {
                background: transparent;
                color: var(--text);
                border: 1px solid var(--border);
            }

            .notes-list-header {
                padding: 8px 12px;
                font-size: 14px;
            }

            .note-item {
                padding: 12px 16px;
            }

            .note-item-title {
                font-size: 15px;
            }

            .note-item-date {
                font-size: 12px;
            }

            /* Mobile checklist styles */
            #checklist-input {
                font-size: 16px;
                padding: 10px;
            }

            .checklist-item {
                padding: 10px;
            }

            .checklist-controls {
                width: 100%;
            }

            .checklist-controls button {
                width: 100%;
            }

            .btn-primary, .btn-secondary {
                padding: 12px 20px;
                font-size: 15px;
            }

            .preview-content {
                padding: 16px;
            }
        }
            
            .mobile-back-btn {
                display: flex !important;
            }
            
            .menu-bar {
                padding: 4px 8px;
                gap: 4px;
            }
            
            .menu-button {
                font-size: 12px;
                padding: 4px 12px;
            }
        }
    </style>
</head>
<body class="ios-dark">
    <div id="app">
        <!-- Header -->
        <div class="header">
            <div class="title">Untitled - AFSNote</div>
        </div>

        <!-- Menu Bar -->
        <div class="menu-bar">
            <div class="dropdown">
                <button class="menu-button" id="file-menu-btn">File</button>
                <div class="dropdown-content" id="file-dropdown">
                    <div class="dropdown-item" id="new-note-btn">New Note</div>
                    <div class="dropdown-item" id="new-list-btn">New List</div>
                    <div class="dropdown-item" id="open-file-btn">Open from Device</div>
                    <div class="dropdown-item" id="save-note-btn">Save Note</div>
                    <div class="dropdown-item" id="save-device-btn">Save to Device</div>
                </div>
            </div>

            <button class="menu-button" id="saved-notes-btn">Saved Notes</button>

            <div class="dropdown">
                <button class="menu-button" id="theme-menu-btn">Theme</button>
                <div class="dropdown-content" id="theme-dropdown">
                    <div class="dropdown-item" data-theme="ios-light">iOS Light</div>
                    <div class="dropdown-item" data-theme="ios-dark">iOS Dark</div>
                    <div class="dropdown-item" data-theme="android-light">Android Light</div>
                    <div class="dropdown-item" data-theme="android-dark">Android Dark</div>
                </div>
            </div>

            <div class="dropdown">
                <button class="menu-button" id="tools-menu-btn">Tools</button>
                <div class="dropdown-content" id="tools-dropdown">
                    <div class="dropdown-item" id="font-size-btn">Font Size</div>
                    <div class="dropdown-item" id="replace-btn">Replace</div>
                    <div class="dropdown-item" id="import-export-btn">Import/Export</div>
                    <div class="dropdown-item" id="about-btn">About</div>
                </div>
            </div>
        </div>

        <!-- Editor Container -->
        <div class="editor-container">
            <textarea id="editor" placeholder="Start typing..."></textarea>

            <!-- Checklist Container -->
            <div id="checklist-container">
                <div class="checklist-items" id="checklist-items"></div>
                <div class="checklist-input-container">
                    <input type="text" id="checklist-input" placeholder="Add item...">
                </div>
                <div class="checklist-controls" style="display: none;">
                    <!-- Controls removed - auto-save handles everything -->
                </div>
            </div>
        </div>
    </div>

    <!-- File Manager -->
    <div id="file-manager">
        <div class="file-manager-header">
            <button class="back-button" id="close-file-manager">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back
            </button>
            <div class="file-manager-title">Saved Notes</div>
        </div>
        <div class="file-manager-content">
            <div class="notes-list-panel">
                <div class="notes-list-header">
                    <span>Notes</span>
                    <div class="dropdown">
                        <button class="menu-button" id="sort-btn">Sort</button>
                        <div class="dropdown-content" id="sort-dropdown">
                            <div class="dropdown-item" data-sort="date-desc">Newest First</div>
                            <div class="dropdown-item" data-sort="date-asc">Oldest First</div>
                            <div class="dropdown-item" data-sort="name-asc">Name (A-Z)</div>
                            <div class="dropdown-item" data-sort="name-desc">Name (Z-A)</div>
                        </div>
                    </div>
                </div>
                <div class="notes-list" id="notes-list"></div>
            </div>
            <div class="resize-handle" id="resize-handle"></div>
            <div class="preview-panel" id="preview-panel">
                <div class="preview-header">
                    <div class="preview-info">
                        <div class="preview-title" id="preview-title">Select a note</div>
                        <div class="preview-date" id="preview-date"></div>
                    </div>
                    <div class="preview-actions">
                        <button class="btn-primary" id="open-note-btn">Edit</button>
                        <button class="btn-secondary" id="delete-note-btn">Delete</button>
                    </div>
                </div>
                <div class="preview-content" id="preview-content">Select a note to preview...</div>
            </div>
        </div>
    </div>

    <!-- Save Note Modal -->
    <div class="modal" id="save-modal">
        <div class="modal-content">
            <div class="modal-header">Save Note</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Note Name</label>
                    <input type="text" class="form-input" id="note-name-input" placeholder="Enter note name">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-save-btn">Cancel</button>
                <button class="btn-primary" id="confirm-save-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Save to Device Modal -->
    <div class="modal" id="save-device-modal">
        <div class="modal-content">
            <div class="modal-header">Save to Device</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">File Name</label>
                    <input type="text" class="form-input" id="filename-input" placeholder="filename">
                </div>
                <div class="form-group">
                    <label class="form-label">File Type</label>
                    <select class="form-select" id="file-type-select">
                        <option value="txt">.txt (Text File)</option>
                        <option value="html">.html (HTML File)</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-device-save-btn">Cancel</button>
                <button class="btn-primary" id="confirm-device-save-btn">Save</button>
            </div>
        </div>
    </div>

    <!-- Font Size Modal -->
    <div class="modal" id="font-size-modal">
        <div class="modal-content">
            <div class="modal-header">Font Size</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Size: <span id="font-size-value">16px</span></label>
                    <input type="range" class="form-input" id="font-size-slider" min="12" max="32" value="16" style="width: 100%">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" id="close-font-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Replace Modal -->
    <div class="modal" id="replace-modal">
        <div class="modal-content">
            <div class="modal-header">Find and Replace</div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Find</label>
                    <input type="text" class="form-input" id="find-input" placeholder="Text to find">
                </div>
                <div class="form-group">
                    <label class="form-label">Replace with</label>
                    <input type="text" class="form-input" id="replace-input" placeholder="Replacement text">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="close-replace-modal">Close</button>
                <button class="btn-primary" id="confirm-replace-btn">Replace All</button>
            </div>
        </div>
    </div>

    <!-- Import/Export Modal -->
    <div class="modal" id="import-export-modal">
        <div class="modal-content">
            <div class="modal-header">Import/Export Notes</div>
            <div class="modal-body">
                <div class="io-section">
                    <div class="io-button" id="import-notes-btn">
                        <div class="io-icon">ðŸ“¥</div>
                        <div class="io-label">Import</div>
                    </div>
                    <div class="io-button" id="export-notes-btn">
                        <div class="io-icon">ðŸ“¤</div>
                        <div class="io-label">Export</div>
                    </div>
                </div>
                <div class="io-warning">Your notes are stored locally in your browser</div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" id="close-io-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div class="modal" id="about-modal">
        <div class="modal-content">
            <div class="modal-header">About AFSNote</div>
            <div class="modal-body">
                <p style="text-align: center; font-weight: 600; margin-bottom: 16px;">AFSNote v2.0</p>
                <p>A simple, privacy-focused note-taking app that stores your notes locally in your browser.</p>
                <p>Features:</p>
                <p>â€¢ Create and manage notes</p>
                <p>â€¢ Checklist functionality</p>
                <p>â€¢ Import/Export notes</p>
                <p>â€¢ Multiple themes</p>
                <p>â€¢ Auto-save</p>
                <p style="margin-top: 16px; text-align: center; color: var(--secondary);">Your notes never leave your device.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" id="close-about-modal">Close</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal" id="delete-modal">
        <div class="modal-content">
            <div class="modal-header">Delete Note</div>
            <div class="modal-body">
                <p>Are you sure you want to delete this note? This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="cancel-delete-btn">Cancel</button>
                <button class="btn-primary" id="confirm-delete-btn" style="background: #ff3b30;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Hidden File Inputs -->
    <input type="file" id="file-input" accept=".txt,text/plain">
    <input type="file" id="import-file-input" accept=".json,application/json">

    <script>
        // Application State
        const state = {
            currentNoteId: null,
            selectedNoteId: null,
            isDirty: false,
            autosaveTimer: null,
            isChecklistMode: false,
            checklistItems: []
        };

        // DOM Elements
        const elements = {
            editor: document.getElementById('editor'),
            title: document.querySelector('.title'),
            checklistContainer: document.getElementById('checklist-container'),
            checklistItems: document.getElementById('checklist-items'),
            checklistInput: document.getElementById('checklist-input'),
            fileManager: document.getElementById('file-manager'),
            notesList: document.getElementById('notes-list'),
            previewPanel: document.getElementById('preview-panel'),
            previewTitle: document.getElementById('preview-title'),
            previewDate: document.getElementById('preview-date'),
            previewContent: document.getElementById('preview-content')
        };

        // Utility Functions
        const $ = (id) => document.getElementById(id);
        const $$ = (selector) => document.querySelectorAll(selector);

        // Theme Management
        const themeManager = {
            init() {
                const savedTheme = localStorage.getItem('afsnote_theme') || 'ios-dark';
                this.setTheme(savedTheme);
                
                $$('[data-theme]').forEach(item => {
                    item.addEventListener('click', () => {
                        this.setTheme(item.dataset.theme);
                        closeAllDropdowns();
                    });
                });
            },
            
            setTheme(theme) {
                document.body.className = theme;
                localStorage.setItem('afsnote_theme', theme);
            }
        };

        // Dropdown Management
        function setupDropdowns() {
            const dropdowns = $$('.dropdown');
            
            dropdowns.forEach(dropdown => {
                const button = dropdown.querySelector('.menu-button');
                const content = dropdown.querySelector('.dropdown-content');
                
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = content.classList.contains('show');
                    closeAllDropdowns();
                    if (!isOpen) {
                        content.classList.add('show');
                    }
                });
            });
            
            document.addEventListener('click', closeAllDropdowns);
        }

        function closeAllDropdowns() {
            $$('.dropdown-content').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }

        // Modal Management
        const modalManager = {
            show(modalId) {
                $(modalId).classList.add('show');
            },
            
            hide(modalId) {
                $(modalId).classList.remove('show');
            }
        };

        // Title Management
        function updateTitle(name = 'Untitled', showSaved = false) {
            const displayName = name.length > 20 ? name.substring(0, 20) + '...' : name;
            const baseTitle = `${displayName} - AFSNote`;
            
            if (showSaved) {
                elements.title.textContent = `âœ“ Saved - ${displayName}`;
                setTimeout(() => {
                    elements.title.textContent = baseTitle;
                }, 1500);
            } else {
                elements.title.textContent = baseTitle;
            }
        }

        // Note Storage
        const noteStorage = {
            getAll() {
                return JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
            },
            
            save(notes) {
                localStorage.setItem('afsnote_notes', JSON.stringify(notes));
            },
            
            add(note) {
                const notes = this.getAll();
                notes.unshift(note);
                this.save(notes);
            },
            
            update(id, updates) {
                const notes = this.getAll();
                const note = notes.find(n => n.id === id);
                if (note) {
                    Object.assign(note, updates);
                    this.save(notes);
                }
            },
            
            delete(id) {
                const notes = this.getAll();
                const filtered = notes.filter(n => n.id !== id);
                this.save(filtered);
            },
            
            getById(id) {
                return this.getAll().find(n => n.id === id);
            }
        };

        // Checklist Management
        const checklistManager = {
            enter() {
                state.isChecklistMode = true;
                elements.editor.style.display = 'none';
                elements.checklistContainer.classList.add('active');
                this.render(); // Render to show current state (empty or with items)
                elements.checklistInput.focus();
            },
            
            exit() {
                state.isChecklistMode = false;
                elements.checklistContainer.classList.remove('active');
                elements.editor.style.display = 'block';
                state.checklistItems = [];
            },
            
            addItem(text) {
                if (!text.trim()) return;
                
                const item = {
                    id: Date.now() + Math.random(),
                    text: text.trim(),
                    completed: false
                };
                
                state.checklistItems.push(item);
                state.isDirty = true;
                this.render();
                this.autosave();
            },
            
            deleteItem(id) {
                state.checklistItems = state.checklistItems.filter(item => item.id !== id);
                state.isDirty = true;
                this.render();
                this.autosave();
            },
            
            toggleItem(id) {
                const item = state.checklistItems.find(item => item.id === id);
                if (item) {
                    item.completed = !item.completed;
                    state.isDirty = true;
                    this.render();
                    this.autosave();
                }
            },
            
            updateItem(id, text) {
                const item = state.checklistItems.find(item => item.id === id);
                if (item) {
                    item.text = text;
                    state.isDirty = true;
                    this.render();
                    this.autosave();
                }
            },
            
            render() {
                elements.checklistItems.innerHTML = '';
                
                state.checklistItems.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'checklist-item' + (item.completed ? ' completed' : '');
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'checklist-checkbox';
                    checkbox.checked = item.completed;
                    checkbox.addEventListener('change', () => this.toggleItem(item.id));
                    
                    const text = document.createElement('span');
                    text.className = 'checklist-text';
                    text.textContent = item.text;
                    
                    const editInput = document.createElement('input');
                    editInput.type = 'text';
                    editInput.className = 'checklist-edit-input';
                    editInput.value = item.text;
                    
                    // Double click to edit
                    text.addEventListener('dblclick', () => {
                        div.classList.add('editing');
                        editInput.focus();
                        editInput.select();
                    });
                    
                    // Save on Enter
                    editInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            if (editInput.value.trim()) {
                                this.updateItem(item.id, editInput.value.trim());
                            }
                            div.classList.remove('editing');
                        } else if (e.key === 'Escape') {
                            div.classList.remove('editing');
                        }
                    });
                    
                    // Save on blur
                    editInput.addEventListener('blur', () => {
                        if (editInput.value.trim() && editInput.value !== item.text) {
                            this.updateItem(item.id, editInput.value.trim());
                        }
                        div.classList.remove('editing');
                    });
                    
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'checklist-delete';
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.addEventListener('click', () => this.deleteItem(item.id));
                    
                    // Long press for delete
                    let pressTimer;
                    const startPress = () => {
                        pressTimer = setTimeout(() => {
                            deleteBtn.classList.add('show');
                            setTimeout(() => deleteBtn.classList.remove('show'), 3000);
                        }, 500);
                    };
                    
                    const cancelPress = () => clearTimeout(pressTimer);
                    
                    div.addEventListener('mousedown', startPress);
                    div.addEventListener('touchstart', startPress);
                    div.addEventListener('mouseup', cancelPress);
                    div.addEventListener('mouseleave', cancelPress);
                    div.addEventListener('touchend', cancelPress);
                    
                    div.appendChild(checkbox);
                    div.appendChild(text);
                    div.appendChild(editInput);
                    div.appendChild(deleteBtn);
                    elements.checklistItems.appendChild(div);
                });
            },
            
            autosave() {
                // Only autosave if the note has been manually saved at least once
                if (state.currentNoteId) {
                    this.saveChecklist();
                }
            },
            
            saveChecklist() {
                noteStorage.update(state.currentNoteId, {
                    checklistItems: JSON.parse(JSON.stringify(state.checklistItems)),
                    isChecklist: true,
                    createdAt: Date.now()
                });
                
                // Show saved message
                const note = noteStorage.getById(state.currentNoteId);
                if (note) {
                    updateTitle(note.name, true);
                }
            },
            
            loadFromText(text) {
                state.checklistItems = [];
                const lines = text.split('\n');
                
                lines.forEach(line => {
                    const trimmed = line.trim();
                    if (trimmed.startsWith('[ ]')) {
                        state.checklistItems.push({
                            id: Date.now() + Math.random(),
                            text: trimmed.substring(3).trim(),
                            completed: false
                        });
                    } else if (trimmed.startsWith('[x]')) {
                        state.checklistItems.push({
                            id: Date.now() + Math.random(),
                            text: trimmed.substring(3).trim(),
                            completed: true
                        });
                    }
                });
                
                this.render();
            },
            
            loadFromItems(items) {
                state.checklistItems = JSON.parse(JSON.stringify(items));
                this.render();
            }
        };

        // File Operations
        const fileOperations = {
            newNote() {
                // Don't create note immediately - wait for user to save and name it
                elements.editor.value = '';
                state.currentNoteId = null;
                state.isDirty = false;
                state.checklistItems = [];
                updateTitle('Untitled');
                
                if (state.isChecklistMode) {
                    checklistManager.exit();
                }
            },
            
            newList() {
                // Don't create note immediately - wait for user to save and name it
                state.currentNoteId = null;
                state.isDirty = false;
                state.checklistItems = [];
                
                // Enter checklist mode with empty list
                checklistManager.enter();
                updateTitle('Untitled List');
            },
            
            openFromDevice() {
                $('file-input').click();
            },
            
            saveNote(name = 'Untitled', isAutosave = false) {
                let noteName = name.trim() || 'Untitled';
                
                if (state.isChecklistMode) {
                    // Save as checklist with items array
                    if (state.currentNoteId) {
                        noteStorage.update(state.currentNoteId, {
                            checklistItems: JSON.parse(JSON.stringify(state.checklistItems)),
                            isChecklist: true,
                            createdAt: Date.now(),
                            name: noteName
                        });
                    } else {
                        const note = {
                            id: Date.now(),
                            name: noteName,
                            checklistItems: JSON.parse(JSON.stringify(state.checklistItems)),
                            isChecklist: true,
                            createdAt: Date.now()
                        };
                        noteStorage.add(note);
                        state.currentNoteId = note.id;
                    }
                } else {
                    // Save as regular note
                    const content = elements.editor.value;
                    
                    if (state.currentNoteId) {
                        noteStorage.update(state.currentNoteId, {
                            content,
                            isChecklist: false,
                            createdAt: Date.now(),
                            name: noteName
                        });
                    } else {
                        const note = {
                            id: Date.now(),
                            name: noteName,
                            content,
                            isChecklist: false,
                            createdAt: Date.now()
                        };
                        noteStorage.add(note);
                        state.currentNoteId = note.id;
                    }
                }
                
                state.isDirty = false;
                updateTitle(noteName, isAutosave);
            },
            
            saveToDevice(filename, type) {
                let finalFilename = filename.trim() || 'Untitled';
                let content = '';
                let mimeType = 'text/plain';
                
                // Get content based on current mode
                if (state.isChecklistMode) {
                    content = state.checklistItems.map(item => {
                        const checkbox = item.completed ? '[x]' : '[ ]';
                        return `${checkbox} ${item.text}`;
                    }).join('\n');
                } else {
                    content = elements.editor.value;
                }
                
                finalFilename = finalFilename.replace(/\.(txt|html)$/i, '');
                
                if (type === 'html') {
                    finalFilename += '.html';
                    mimeType = 'text/html';
                    
                    if (!content.includes('<html')) {
                        content = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${finalFilename.replace('.html', '')}</title>
</head>
<body>
${content}
</body>
</html>`;
                    }
                } else {
                    finalFilename += '.txt';
                }
                
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = finalFilename;
                a.click();
                URL.revokeObjectURL(url);
            },
            
            importNotes(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedNotes = JSON.parse(e.target.result);
                        if (!Array.isArray(importedNotes)) {
                            throw new Error('Invalid file format');
                        }
                        
                        const existingNotes = noteStorage.getAll();
                        const existingIds = new Set(existingNotes.map(n => n.id));
                        let count = 0;
                        
                        importedNotes.forEach(note => {
                            if (note.id && note.name && note.content && !existingIds.has(note.id)) {
                                noteStorage.add(note);
                                count++;
                            }
                        });
                        
                        alert(`Imported ${count} notes successfully!`);
                    } catch (err) {
                        alert(`Error importing notes: ${err.message}`);
                    }
                };
                reader.readAsText(file);
            },
            
            exportNotes() {
                const notes = noteStorage.getAll();
                if (notes.length === 0) {
                    alert('No notes to export!');
                    return;
                }
                
                const now = new Date();
                const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `afsnote_export_${timestamp}.json`;
                
                const blob = new Blob([JSON.stringify(notes, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            }
        };

        // File Manager
        const fileManager = {
            show() {
                this.render();
                elements.fileManager.classList.add('show');
            },
            
            hide() {
                elements.fileManager.classList.remove('show');
            },
            
            render(sortOrder = 'date-desc') {
                let notes = noteStorage.getAll();
                
                // Sort notes
                switch(sortOrder) {
                    case 'name-asc':
                        notes.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        notes.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'date-asc':
                        notes.sort((a, b) => a.createdAt - b.createdAt);
                        break;
                    case 'date-desc':
                        notes.sort((a, b) => b.createdAt - a.createdAt);
                        break;
                }
                
                elements.notesList.innerHTML = '';
                
                notes.forEach(note => {
                    const div = document.createElement('div');
                    div.className = 'note-item';
                    div.dataset.noteId = note.id;
                    
                    const title = document.createElement('div');
                    title.className = 'note-item-title';
                    // Add checklist icon if it's a checklist
                    const icon = note.isChecklist ? 'â˜‘ ' : '';
                    title.textContent = icon + note.name;
                    
                    const date = document.createElement('div');
                    date.className = 'note-item-date';
                    date.textContent = new Date(note.createdAt).toLocaleString();
                    
                    div.appendChild(title);
                    div.appendChild(date);
                    elements.notesList.appendChild(div);
                });
            },
            
            selectNote(id) {
                const note = noteStorage.getById(id);
                if (!note) return;
                
                $$('.note-item').forEach(item => item.classList.remove('active'));
                const selectedItem = document.querySelector(`[data-note-id="${id}"]`);
                if (selectedItem) selectedItem.classList.add('active');
                
                state.selectedNoteId = id;
                elements.previewTitle.textContent = note.name;
                elements.previewDate.textContent = new Date(note.createdAt).toLocaleString();
                
                // Check if it's a stored checklist
                if (note.isChecklist && note.checklistItems) {
                    let html = '<div>';
                    note.checklistItems.forEach(item => {
                        if (item.completed) {
                            html += `<div style="margin: 8px 0; text-decoration: line-through; opacity: 0.7;">â˜‘ ${item.text}</div>`;
                        } else {
                            html += `<div style="margin: 8px 0;">â˜ ${item.text}</div>`;
                        }
                    });
                    html += '</div>';
                    elements.previewContent.innerHTML = html;
                } else if (note.content) {
                    // Check if old format checklist (text-based)
                    const isChecklist = note.content.includes('[ ]') || note.content.includes('[x]');
                    
                    if (isChecklist) {
                        let html = '<div>';
                        note.content.split('\n').forEach(line => {
                            const trimmed = line.trim();
                            if (trimmed.startsWith('[ ]')) {
                                html += `<div style="margin: 8px 0;">â˜ ${trimmed.substring(3).trim()}</div>`;
                            } else if (trimmed.startsWith('[x]')) {
                                html += `<div style="margin: 8px 0; text-decoration: line-through; opacity: 0.7;">â˜‘ ${trimmed.substring(3).trim()}</div>`;
                            } else if (trimmed) {
                                html += `<div style="margin: 8px 0;">${trimmed}</div>`;
                            }
                        });
                        html += '</div>';
                        elements.previewContent.innerHTML = html;
                    } else {
                        elements.previewContent.textContent = note.content;
                    }
                } else {
                    elements.previewContent.textContent = '';
                }
            },
            
            openNote() {
                if (!state.selectedNoteId) return;
                
                const note = noteStorage.getById(state.selectedNoteId);
                if (!note) return;
                
                // Check if it's a stored checklist
                if (note.isChecklist && note.checklistItems) {
                    checklistManager.loadFromItems(note.checklistItems);
                    checklistManager.enter();
                } else if (note.content) {
                    // Check if old format checklist
                    const isChecklist = note.content.includes('[ ]') || note.content.includes('[x]');
                    
                    if (isChecklist) {
                        // Convert old format to new format
                        checklistManager.loadFromText(note.content);
                        checklistManager.enter();
                    } else {
                        elements.editor.value = note.content;
                        if (state.isChecklistMode) {
                            checklistManager.exit();
                        }
                    }
                } else {
                    elements.editor.value = '';
                    if (state.isChecklistMode) {
                        checklistManager.exit();
                    }
                }
                
                state.currentNoteId = note.id;
                state.isDirty = false;
                updateTitle(note.name);
                this.hide();
            },
            
            deleteNote() {
                if (!state.selectedNoteId) return;
                modalManager.show('delete-modal');
            },
            
            confirmDelete() {
                if (!state.selectedNoteId) return;
                
                noteStorage.delete(state.selectedNoteId);
                state.selectedNoteId = null;
                
                elements.previewTitle.textContent = 'Select a note';
                elements.previewDate.textContent = '';
                elements.previewContent.textContent = 'Select a note to preview...';
                
                this.render();
                modalManager.hide('delete-modal');
            }
        };

        // Replace functionality
        function replaceAll() {
            const findText = $('find-input').value;
            const replaceText = $('replace-input').value;
            
            if (!findText) {
                alert('Please enter text to find');
                return;
            }
            
            const regex = new RegExp(findText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
            const currentText = elements.editor.value;
            
            if (regex.test(currentText)) {
                elements.editor.value = currentText.replace(regex, replaceText);
                alert('All occurrences replaced!');
            } else {
                alert('Text not found');
            }
        }

        // Autosave
        function setupAutosave() {
            elements.editor.addEventListener('input', () => {
                state.isDirty = true;
                clearTimeout(state.autosaveTimer);
                
                state.autosaveTimer = setTimeout(() => {
                    if (state.currentNoteId && state.isDirty) {
                        const note = noteStorage.getById(state.currentNoteId);
                        if (note) {
                            fileOperations.saveNote(note.name, true);
                        }
                    }
                }, 1500);
            });
        }

        // Event Listeners
        function setupEventListeners() {
            // File Menu
            $('new-note-btn').addEventListener('click', () => {
                fileOperations.newNote();
                closeAllDropdowns();
            });
            
            $('new-list-btn').addEventListener('click', () => {
                fileOperations.newList();
                closeAllDropdowns();
            });
            
            $('open-file-btn').addEventListener('click', () => {
                fileOperations.openFromDevice();
                closeAllDropdowns();
            });
            
            $('save-note-btn').addEventListener('click', () => {
                if (state.currentNoteId) {
                    const note = noteStorage.getById(state.currentNoteId);
                    fileOperations.saveNote(note.name);
                    alert('Note saved!');
                } else {
                    modalManager.show('save-modal');
                }
                closeAllDropdowns();
            });
            
            $('save-device-btn').addEventListener('click', () => {
                modalManager.show('save-device-modal');
                closeAllDropdowns();
            });
            
            // Saved Notes
            $('saved-notes-btn').addEventListener('click', () => {
                // Don't exit checklist mode, just show file manager
                fileManager.show();
            });
            
            // Tools Menu
            $('font-size-btn').addEventListener('click', () => {
                const currentSize = parseInt(elements.editor.style.fontSize) || 16;
                $('font-size-slider').value = currentSize;
                $('font-size-value').textContent = `${currentSize}px`;
                modalManager.show('font-size-modal');
                closeAllDropdowns();
            });
            
            $('replace-btn').addEventListener('click', () => {
                modalManager.show('replace-modal');
                closeAllDropdowns();
            });
            
            $('import-export-btn').addEventListener('click', () => {
                modalManager.show('import-export-modal');
                closeAllDropdowns();
            });
            
            $('about-btn').addEventListener('click', () => {
                modalManager.show('about-modal');
                closeAllDropdowns();
            });
            
            // Checklist
            elements.checklistInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    checklistManager.addItem(elements.checklistInput.value);
                    elements.checklistInput.value = '';
                }
            });
            
            
            // File Manager
            $('close-file-manager').addEventListener('click', () => {
                fileManager.hide();
            });
            
            elements.notesList.addEventListener('click', (e) => {
                const noteItem = e.target.closest('.note-item');
                if (noteItem) {
                    fileManager.selectNote(Number(noteItem.dataset.noteId));
                }
            });
            
            $('open-note-btn').addEventListener('click', () => {
                fileManager.openNote();
            });
            
            $('delete-note-btn').addEventListener('click', () => {
                fileManager.deleteNote();
            });
            
            // Resize handle functionality for mobile
            const resizeHandle = $('resize-handle');
            const notesListPanel = document.querySelector('.notes-list-panel');
            const previewPanel = elements.previewPanel;
            
            if (resizeHandle && notesListPanel && previewPanel) {
                let isResizing = false;
                let startY = 0;
                let startListHeight = 0;
                
                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startY = e.clientY;
                    startListHeight = notesListPanel.offsetHeight;
                    document.body.style.cursor = 'row-resize';
                    resizeHandle.classList.add('dragging');
                    e.preventDefault();
                });
                
                resizeHandle.addEventListener('touchstart', (e) => {
                    isResizing = true;
                    startY = e.touches[0].clientY;
                    startListHeight = notesListPanel.offsetHeight;
                    resizeHandle.classList.add('dragging');
                    e.preventDefault();
                }, { passive: false });
                
                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;
                    
                    const deltaY = e.clientY - startY;
                    const fileManagerContent = document.querySelector('.file-manager-content');
                    const totalHeight = fileManagerContent.offsetHeight;
                    const newListHeight = startListHeight + deltaY;
                    const minHeight = 100;
                    const maxHeight = totalHeight - minHeight - 8; // 8px for handle
                    
                    if (newListHeight >= minHeight && newListHeight <= maxHeight) {
                        const listPercent = (newListHeight / totalHeight) * 100;
                        const previewPercent = 100 - listPercent - (8 / totalHeight * 100);
                        
                        notesListPanel.style.height = `${listPercent}%`;
                        previewPanel.style.height = `${previewPercent}%`;
                    }
                });
                
                document.addEventListener('touchmove', (e) => {
                    if (!isResizing) return;
                    
                    const deltaY = e.touches[0].clientY - startY;
                    const fileManagerContent = document.querySelector('.file-manager-content');
                    const totalHeight = fileManagerContent.offsetHeight;
                    const newListHeight = startListHeight + deltaY;
                    const minHeight = 100;
                    const maxHeight = totalHeight - minHeight - 8;
                    
                    if (newListHeight >= minHeight && newListHeight <= maxHeight) {
                        const listPercent = (newListHeight / totalHeight) * 100;
                        const previewPercent = 100 - listPercent - (8 / totalHeight * 100);
                        
                        notesListPanel.style.height = `${listPercent}%`;
                        previewPanel.style.height = `${previewPercent}%`;
                    }
                }, { passive: false });
                
                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = '';
                        resizeHandle.classList.remove('dragging');
                    }
                });
                
                document.addEventListener('touchend', () => {
                    if (isResizing) {
                        isResizing = false;
                        resizeHandle.classList.remove('dragging');
                    }
                });
            }
            
            // Sort
            $$('#sort-dropdown .dropdown-item').forEach(item => {
                item.addEventListener('click', () => {
                    fileManager.render(item.dataset.sort);
                });
            });
            
            // Save Modal
            $('cancel-save-btn').addEventListener('click', () => {
                modalManager.hide('save-modal');
            });
            
            $('confirm-save-btn').addEventListener('click', () => {
                const name = $('note-name-input').value;
                fileOperations.saveNote(name);
                modalManager.hide('save-modal');
                $('note-name-input').value = '';
            });
            
            // Save to Device Modal
            $('cancel-device-save-btn').addEventListener('click', () => {
                modalManager.hide('save-device-modal');
            });
            
            $('confirm-device-save-btn').addEventListener('click', () => {
                const filename = $('filename-input').value;
                const type = $('file-type-select').value;
                fileOperations.saveToDevice(filename, type);
                modalManager.hide('save-device-modal');
                $('filename-input').value = '';
            });
            
            // Font Size Modal
            $('font-size-slider').addEventListener('input', (e) => {
                const size = e.target.value;
                elements.editor.style.fontSize = `${size}px`;
                $('font-size-value').textContent = `${size}px`;
            });
            
            $('close-font-modal').addEventListener('click', () => {
                modalManager.hide('font-size-modal');
            });
            
            // Replace Modal
            $('confirm-replace-btn').addEventListener('click', () => {
                replaceAll();
            });
            
            $('close-replace-modal').addEventListener('click', () => {
                modalManager.hide('replace-modal');
            });
            
            // Import/Export Modal
            $('import-notes-btn').addEventListener('click', () => {
                $('import-file-input').click();
            });
            
            $('export-notes-btn').addEventListener('click', () => {
                fileOperations.exportNotes();
            });
            
            $('close-io-modal').addEventListener('click', () => {
                modalManager.hide('import-export-modal');
            });
            
            // About Modal
            $('close-about-modal').addEventListener('click', () => {
                modalManager.hide('about-modal');
            });
            
            // Delete Modal
            $('cancel-delete-btn').addEventListener('click', () => {
                modalManager.hide('delete-modal');
            });
            
            $('confirm-delete-btn').addEventListener('click', () => {
                fileManager.confirmDelete();
            });
            
            // File Inputs
            $('file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    elements.editor.value = e.target.result;
                    state.currentNoteId = null;
                    state.isDirty = false;
                    updateTitle(file.name.replace(/\.[^/.]+$/, ''));
                };
                reader.readAsText(file);
                e.target.value = '';
            });
            
            $('import-file-input').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                fileOperations.importNotes(file);
                e.target.value = '';
            });
        }

        // Initialize Application
        function init() {
            themeManager.init();
            setupDropdowns();
            setupAutosave();
            setupEventListeners();
            updateTitle('Untitled');
        }

        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', init);
        
        // Prevent data loss on page refresh
        window.addEventListener('beforeunload', (e) => {
            if (state.isDirty && (elements.editor.value || state.checklistItems.length > 0)) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
