<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AFSNote</title>
    <link rel="icon" type="image/x-icon" href="https://busland.neocities.org/hobopad.ico">
    <link rel="manifest" href="manifest.json">

    <style>
        /* --- Base Styles --- */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: "Tahoma", "Geneva", sans-serif; transition: background-color 0.3s; }
        #app-window, #file-manager-window { width: 100vw; height: 100vh; display: flex; flex-direction: column; box-sizing: border-box; overflow: hidden; }
        .modal-content { width: 100%; display: flex; flex-direction: column; box-sizing: border-box; overflow: hidden; flex-shrink: 1; min-height: 0; }
        
        /* Updated Title Bar Styles */
        .title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            flex-shrink: 0;
        }
        
        .title-bar-text {
            position: absolute;
            left: 0;
            right: 0;
            text-align: center;
            pointer-events: none;
            z-index: 1;
            padding: 0 60px;
        }
        
        .title-bar-controls {
            margin-left: auto;
            z-index: 2;
            display: flex;
            gap: 3px;
        }
        
        .window-body { display: flex; flex-direction: column; flex-grow: 1; margin: 0; padding: 0; min-height: 0; }
        .menu-bar { flex-shrink: 0; position: relative; z-index: 10; }
        #editor { flex-grow: 1; padding: 5px; margin: 0; resize: none; outline: none; line-height: 1.6; width: 100%; box-sizing: border-box; overflow-y: scroll; border: none; }
        .modal { display: none; width: 90%; max-width: 340px; max-height: 80vh; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 201; flex-direction: column; }
        #font-size-modal, #replace-modal, #import-export-modal { max-width: 300px; }
        #about-modal {
            width: 90vmin;
            height: 90vmin;
            max-width: 680px;
            max-height: 680px;
            container-type: inline-size;
        }
        .modal .window-body { overflow: auto; padding: 10px; }
        .field-row { display: flex; justify-content: flex-end; gap: 8px; margin-top: 15px; }
        #file-opener, #import-file-opener { display: none; }

        /* --- Checklist Feature Styles --- */
        #checklist-container {
            display: none;
            flex-direction: column;
            padding: 10px;
            background: #2c2c2c;
            border: 1px solid #555;
            border-radius: 8px;
            margin: 10px;
            max-height: 80vh;
            overflow-y: auto;
            max-width: 100%;
            box-sizing: border-box;
            color: #e0e0e0; /* Light text for container */
        }
        
        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 10px;
            max-width: 100%;
            color: #e0e0e0; /* Light text */
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            padding: 8px;
            padding-right: 50px; /* Space for delete button */
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            position: relative;
            user-select: none;
            transition: all 0.3s ease;
            min-height: 40px;
            width: 100%;
            box-sizing: border-box;
            color: #e0e0e0; /* Light text for items */
        }
        
        .checklist-item.completed .checklist-text {
            text-decoration: line-through;
            opacity: 0.6;
        }
        
        .checklist-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: #007aff;
        }
        
        /* Theme-specific checkbox styles */
        .theme-win95 .checklist-checkbox {
            accent-color: #000080;
        }
        
        .theme-winxp .checklist-checkbox {
            accent-color: #316AC5;
        }
        
        .theme-ios .checklist-checkbox {
            accent-color: #0a84ff;
            border-radius: 50%;
        }
        
        .theme-android .checklist-checkbox {
            accent-color: #8ab4f8;
        }
        
        .theme-git .checklist-checkbox {
            accent-color: #238636;
        }
        
        .checklist-text {
            flex-grow: 1;
            padding: 5px;
            color: #e0e0e0; /* Light color for all themes */
            word-break: break-word;
            overflow-wrap: break-word;
            cursor: default;
        }
        
        .checklist-item.completed .checklist-text {
            text-decoration: line-through;
            opacity: 0.6;
            color: #a0a0a0; /* Lighter gray for completed items */
        }
        
        .checklist-text.editing {
            display: none;
        }
        
        .checklist-edit-input {
            flex-grow: 1;
            padding: 5px;
            background-color: #2c2c2c;
            color: #e0e0e0; /* Light text color */
            border: 1px solid #555;
            border-radius: 4px;
            font-size: inherit;
            font-family: inherit;
            display: none;
        }
        
        .checklist-edit-input.active {
            display: block;
        }
        
        .checklist-item.editing .checklist-edit-input {
            display: block;
        }
        
        .checklist-item.editing .checklist-text {
            display: none;
        }
        
        .checklist-delete {
            position: absolute;
            right: -100%;
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: right 0.3s ease;
            white-space: nowrap;
        }
        
        .checklist-delete.show {
            right: 5px;
        }
        
        #checklist-input-container {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            max-width: 100%;
        }
        
        #checklist-input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #555;
            border-radius: 4px;
            font-size: 14px;
            background-color: #3c3c3c;
            color: #e0e0e0;
            min-width: 0; /* Allow shrinking on mobile */
        }
        
        .checklist-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }
        
        .checklist-close-btn, .checklist-edit-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            background-color: #007aff;
            color: white;
        }
        
        .checklist-close-btn:hover, .checklist-edit-btn:hover {
            background-color: #005bb5;
        }

        /* --- Custom About Modal Background --- */
        #about-modal p {
            color: #e0e0e0;
        }
        #about-modal .window-body p:first-of-type {
            font-size: 3.5cqw;
        }
        #about-modal .window-body p:nth-of-type(2) {
            font-size: 2.5cqw;
        }
        #about-modal .window-body .field-row {
            font-size: 3cqw;
        }

        /* --- Version Display Style --- */
        .version-display {
            font-size: 0.8em;
            font-weight: normal;
            opacity: 0.7;
            padding-right: 5px;
            user-select: none;
        }

        /* --- Font Size Display --- */
        #font-size-display { text-align: center; margin-top: 10px; }

        /* --- Import/Export Styles --- */
        #import-export-modal .window-body { display: flex; flex-wrap: wrap; justify-content: space-around; text-align: center; padding-top: 20px; padding-bottom: 10px; }
        .io-section { width: 45%; margin-bottom: 10px; }
        .io-section button { width: 80px; height: 60px; font-size: 2em; line-height: 1; }
        .io-section p { margin-top: 5px; font-size: 0.9em; }
        .io-warning { width: 100%; color: #888; font-size: 0.8em; text-align: center; margin-top: 15px; }

        /* --- Dropdown Menu Styles --- */
        .menu-item { position: relative; user-select: none; }
        .dropdown-content { display: none; position: absolute; top: 100%; right: 0; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 100; list-style: none; padding: 0; margin: 0; }
        .menu-item:not(.menu-item-right) .dropdown-content { right: auto; left: 0; }
        .dropdown-content li { padding: 8px 12px; cursor: pointer; color: black; border-bottom: 1px solid #ddd; }
        .dropdown-content li:last-child { border-bottom: none; }
        
        /* --- File Manager Styles --- */
        #file-manager-window { 
            position: fixed; 
            top: 0; 
            left: 0; 
            z-index: 200; 
            display: none;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        #file-manager-content { 
            display: flex; 
            flex-grow: 1; 
            min-height: 0; 
            height: calc(100% - 30px);
        }
        #notes-list-container { 
            width: 40%; 
            display: flex; 
            flex-direction: column; 
            border-right: 1px solid;
            overflow-y: auto;
        }
        .notes-list-header { 
            display: flex; 
            padding: 4px 8px; 
            font-weight: bold; 
            border-bottom: 1px solid; 
            flex-shrink: 0; 
            align-items: center; 
            background-color: inherit;
        }
        .header-name { flex-grow: 1; }
        #note-preview-container { 
            width: 60%; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        }
        #note-preview-header { 
            padding: 8px; 
            border-bottom: 1px solid; 
            flex-shrink: 0; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: inherit;
        }
        #note-preview-title { font-weight: bold; font-size: 1.2em; }
        #note-preview-date { font-size: 0.9em; opacity: 0.8; }
        #note-preview-actions { margin-top: 0; display: flex; gap: 8px; }
        #note-preview-actions button, #filter-btn {
            padding: 4px 10px;
            font-size: 14px;
            min-height: initial;
        }
        #note-preview { 
            flex-grow: 1; 
            padding: 10px; 
            overflow-y: auto; 
            white-space: pre-wrap;
            height: 100%;
        }
        
        /* Checklist preview styles */
        .checklist-preview-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checklist-preview-item.completed {
            text-decoration: line-through;
            opacity: 0.7;
        }
        .note-item { 
            display: flex; 
            align-items: flex-start; 
            padding: 8px; 
            cursor: pointer; 
            border-bottom: 1px solid; 
            gap: 8px; 
            margin-bottom: 5px;
            background-color: inherit;
        }
        .note-item .file-icon { width: 16px; height: 16px; flex-shrink: 0; margin-top: 2px; }
        .note-item-details { flex-grow: 1; display: flex; flex-direction: column; }
        .note-item-title { font-weight: bold; }
        .note-item-date { font-size: 0.9em; opacity: 0.8; }
        #notes-list {
            overflow-y: auto;
            flex-grow: 1;
        }

        /* --- Unified Back Button --- */
        #file-manager-back-btn {
            display: none; /* Hidden by default */
            background: none;
            border: none;
            cursor: pointer;
        }
        
        /* --- Windows 95 Theme --- */
        .theme-win95 body { background: #121212; }
        .theme-win95 #app-window, .theme-win95 .modal-content, .theme-win95 #file-manager-window { background-color: #2c2c2c; border: 3px solid #555; border-top-color: #666; border-left-color: #666; border-right-color: #000; border-bottom-color: #000; border-radius: 0; box-shadow: none; }
        .theme-win95 .title-bar { 
            background: linear-gradient(90deg, #000080, #1084d0); 
            padding: 3px 5px; 
            color: white; 
            font-weight: bold; 
            height: 20px; 
            border-bottom: none; 
            text-shadow: none; 
        }
        .theme-win95 .title-bar-text { padding: 0 50px; color: white; }
        .theme-win95 .menu-bar { display: flex; flex-wrap: wrap; justify-content: flex-end; list-style: none; margin: 0; padding: 2px; border-bottom: 1px solid #555; background: #2c2c2c; gap: 0; }
        .theme-win95 .menu-bar > li { padding: 2px 8px; font-size: 14px; border-radius: 0; border: none; background: #3c3c3c; box-shadow: none; color: #e0e0e0; }
        .theme-win95 .menu-bar > li:hover { background: #000080; color: white; }
        .theme-win95 .window-body { padding: 0; box-shadow: inset -1px -1px #666, inset 1px 1px #000, inset -2px -2px #555, inset 2px 2px #333; }
        .theme-win95 #editor, .theme-win95 #note-preview { background-color: #1e1e1e; color: #e0e0e0; border: none; font-family: 'Lucida Console', Courier, monospace; font-size: 16px; margin: 2px; }
        .theme-win95 button, .theme-win95 select, .theme-win95 input[type="text"] { font-family: "Tahoma", sans-serif; font-size: 14px; background-color: #3c3c3c; color: #e0e0e0; border: 1px solid #555; border-radius: 0; padding: 4px 15px; min-height: 23px; }
        .theme-win95 .dropdown-content { border: 1px solid #555; border-radius: 0; background-color: #2c2c2c; }
        .theme-win95 .dropdown-content li { border-bottom: 1px solid #555; color: #e0e0e0; }
        .theme-win95 .dropdown-content li:hover { background: #000080; color: white; }
        .theme-win95 #about-modal p { color: #e0e0e0; }
        .theme-win95 .note-item { border-bottom-color: #555; }
        .theme-win95 .note-item.active { background-color: #000080; color: white; }
        .theme-win95 .note-item.active .file-icon { fill: white; }
        .theme-win95 .file-icon { fill: #e0e0e0; }

        /* --- Windows XP Theme (Dark) --- */
        .theme-winxp body { background: #121212; }
        .theme-winxp #app-window, .theme-winxp .modal-content, .theme-winxp #file-manager-window { background-color: #1e1e1e; border: 1px solid #333; box-shadow: 0 0 10px rgba(0,0,0,0.5); border-radius: 6px; }
        .theme-winxp .title-bar { 
            background: linear-gradient(to bottom, #0058e1, #3d80f2 4%, #3d80f2 96%, #0058e1); 
            padding: 3px 5px; 
            color: white; 
            font-weight: bold; 
            height: 25px; 
            border-bottom: 1px solid #333; 
            font-size: 12px; 
        }
        .theme-winxp .title-bar-text { padding: 0 60px; color: white; }
        .theme-winxp .menu-bar { display: flex; flex-wrap: wrap; justify-content: flex-end; list-style: none; margin: 0; padding: 2px; background: #2c2c2c; border-bottom: 1px solid #333; gap: 0; }
        .theme-winxp .menu-bar > li { padding: 4px 8px; font-size: 11px; border: 1px solid transparent; border-radius: 0; background: #3c3c3c; box-shadow: none; color: #e0e0e0; }
        .theme-winxp .menu-bar > li:hover { background: #316AC5; color: white; border: 1px solid #000; }
        .theme-winxp .window-body { padding: 3px; box-shadow: none; background-color: #1e1e1e; }
        .theme-winxp #editor, .theme-winxp #note-preview, .theme-winxp input, .theme-winxp select { border: 1px solid #555; background-color: #2c2c2c; color: #e0e0e0; font-family: 'Lucida Console', Courier, monospace; font-size: 12px; margin: 0; }
        .theme-winxp button, .theme-winxp select, .theme-winxp input[type="text"] { font-family: "Tahoma", sans-serif; font-size: 11px; border: 1px solid #555; background: #3c3c3c; color: #e0e0e0; padding: 3px 12px; min-height: 23px; border-radius: 0; }
        .theme-winxp .dropdown-content { border: 1px solid #333; border-radius: 0; background-color: #2c2c2c; }
        .theme-winxp .dropdown-content li { border-bottom: 1px solid #333; color: #e0e0e0; }
        .theme-winxp .dropdown-content li:hover { background: #316AC5; color: white; }
        .theme-winxp #about-modal p { color: #e0e0e0; }
        .theme-winxp .note-item { border-bottom-color: #333; }
        .theme-winxp .note-item.active { background-color: #316AC5; color: white; }
        .theme-winxp .note-item.active .file-icon { fill: white; }
        .theme-winxp .file-icon { fill: #e0e0e0; }

        /* --- iOS Theme (Dark) --- */
        .theme-ios body { background: #000; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .theme-ios #app-window, .theme-ios .modal-content, .theme-ios #file-manager-window { background-color: #1c1c1e; border: 1px solid #333; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .theme-ios .title-bar { 
            background: #1c1c1e; 
            padding: 10px; 
            color: #fff; 
            font-weight: 600; 
            height: auto; 
            border-bottom: 1px solid #333; 
        }
        .theme-ios .title-bar-text { 
            font-size: 17px; 
            padding: 0 70px; 
            color: #fff;
        }
        .theme-ios .menu-bar { display: flex; flex-wrap: wrap; justify-content: flex-end; list-style: none; margin: 0; padding: 8px; background: #1c1c1e; gap: 4px; border-bottom: 1px solid #333; }
        .theme-ios .menu-bar > li { padding: 5px 10px; font-size: 14px; font-weight: bold; border-radius: 8px; border: none; background: none; box-shadow: none; color: #0a84ff; cursor: pointer; }
        .theme-ios .menu-bar > li:hover { background: #2c2c2e; }
        .theme-ios .window-body { padding: 0; box-shadow: none; background-color: #1c1c1e; }
        .theme-ios #editor, .theme-ios #note-preview { background-color: #1c1c1e; border: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 17px; padding: 12px; line-height: 1.5; color: #fff; }
        .theme-ios button, .theme-ios select, .theme-ios input[type="text"] { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 17px; border: 1px solid #444; background-color: #2c2c2c; color: #fff; border-radius: 8px; padding: 8px 12px; min-height: 36px; }
        .theme-ios button { background-color: #0a84ff; color: white; border: none; }
        .theme-ios button:active { background-color: #0066cc; }
        .theme-ios button.primary { background-color: #30d158; }
        .theme-ios button.primary:active { background-color: #28a745; }
        .theme-ios .title-bar-controls { display: none; }
        .theme-ios .dropdown-content { border: 1px solid #333; border-radius: 8px; background-color: #1c1c1e; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .theme-ios .dropdown-content li { color: #0a84ff; border-bottom: 1px solid #333; }
        .theme-ios .dropdown-content li:hover { background: #2c2c2e; }
        .theme-ios #about-modal p { color: #fff; }
        .theme-ios #notes-list-container, .theme-ios .notes-list-header, .theme-ios .note-item, .theme-ios #note-preview-header { border-color: #333; background-color: #1c1c1e; }
        .theme-ios .note-item.active { background-color: #0a84ff; color: #fff; }
        .theme-ios .note-item.active .file-icon { fill: #fff; }
        .theme-ios .file-icon { fill: #8e8e93; }
        .theme-ios #file-manager-window .title-bar-controls { display: none; }
        .theme-ios #file-manager-back-btn { 
            display: block !important;
            color: #0a84ff;
            font-size: 17px;
            font-weight: 400;
            padding: 0 10px;
        }

        /* --- Git Theme (GitHub Dark - Always Dark Mode) --- */
        .theme-git body { 
            background-color: #0d1117; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji"; 
        }
        .theme-git #app-window, .theme-git .modal-content, .theme-git #file-manager-window { 
            background-color: #0d1117; 
            border: 1px solid #30363d; 
            border-radius: 6px; 
            box-shadow: 0 0 0 1px rgba(27,31,36,0.15), 0 8px 24px rgba(1,4,9,0.25); 
        }
        .theme-git .title-bar { 
            background: #161b22; 
            padding: 10px 16px; 
            color: #f0f6fc; 
            font-weight: 600; 
            height: auto; 
            border-bottom: 1px solid #30363d; 
            font-size: 14px; 
        }
        .theme-git .title-bar-text { 
            font-size: 14px; 
            padding: 0 80px; 
            color: #f0f6fc;
        }
        .theme-git .menu-bar { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: flex-end; 
            list-style: none; 
            margin: 0; 
            padding: 8px 16px; 
            background: #0d1117; 
            gap: 8px; 
            border-bottom: 1px solid #21262d; 
        }
        .theme-git .menu-bar > li { 
            padding: 5px 12px; 
            font-size: 14px; 
            border-radius: 6px; 
            border: 1px solid #30363d; 
            background: #21262d; 
            box-shadow: none; 
            color: #c9d1d9; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        .theme-git .menu-bar > li:hover { 
            background: #30363d; 
            border-color: #8b949e; 
        }
        .theme-git .window-body { 
            padding: 0; 
            box-shadow: none; 
            background-color: #0d1117; 
        }
        .theme-git #editor, .theme-git #note-preview { 
            background-color: #0d1117; 
            border: none; 
            font-family: ui-monospace, SFMono-Regular, "SF Mono", Consolas, "Liberation Mono", Menlo, monospace; 
            font-size: 14px; 
            padding: 16px; 
            line-height: 1.45; 
            color: #c9d1d9; 
        }
        .theme-git ::-webkit-scrollbar { 
            width: 14px; 
            height: 14px; 
        }
        .theme-git ::-webkit-scrollbar-track { 
            background: #161b22; 
            border-radius: 6px; 
        }
        .theme-git ::-webkit-scrollbar-thumb { 
            background-color: #484f58; 
            border: 3px solid #161b22; 
            border-radius: 8px; 
        }
        .theme-git ::-webkit-scrollbar-thumb:hover { 
            background-color: #6e7681; 
        }
        .theme-git button, .theme-git select, .theme-git input[type="text"] { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; 
            font-size: 14px; 
            border: 1px solid #30363d; 
            background-color: #21262d; 
            color: #c9d1d9; 
            border-radius: 6px; 
            padding: 5px 16px; 
            min-height: 32px; 
            transition: all 0.2s; 
        }
        .theme-git button { 
            background-color: #238636; 
            color: white; 
            border: 1px solid rgba(240,246,252,0.1); 
            font-weight: 500; 
        }
        .theme-git button:hover { 
            background-color: #2ea043; 
            border-color: rgba(240,246,252,0.1); 
        }
        .theme-git button:active { 
            background-color: #238636; 
        }
        .theme-git button.primary { 
            background-color: #1f6feb; 
        }
        .theme-git button.primary:hover { 
            background-color: #388bfd; 
        }
        .theme-git .title-bar-controls { 
            display: none; 
        }
        .theme-git .dropdown-content { 
            border: 1px solid #30363d; 
            border-radius: 6px; 
            background-color: #161b22; 
            box-shadow: 0 8px 24px rgba(1,4,9,0.25); 
        }
        .theme-git .dropdown-content li { 
            color: #c9d1d9; 
            border-bottom: 1px solid #21262d; 
            padding: 8px 16px; 
            transition: background-color 0.2s; 
        }
        .theme-git .dropdown-content li:hover { 
            background: #1f6feb; 
            color: #ffffff; 
        }
        .theme-git .dropdown-content li:last-child { 
            border-bottom: none; 
        }
        .theme-git #about-modal p { 
            color: #c9d1d9; 
        }
        .theme-git #notes-list-container, 
        .theme-git .notes-list-header, 
        .theme-git .note-item, 
        .theme-git #note-preview-header { 
            border-color: #30363d; 
        }
        .theme-git .notes-list-header { 
            background-color: #161b22; 
            color: #c9d1d9; 
        }
        .theme-git .note-item { 
            background-color: #0d1117; 
            color: #c9d1d9; 
            transition: background-color 0.2s; 
        }
        .theme-git .note-item:hover { 
            background-color: #161b22; 
        }
        .theme-git .note-item.active { 
            background-color: #1f6feb; 
            color: #ffffff; 
        }
        .theme-git .note-item.active .file-icon { 
            fill: #ffffff; 
        }
        .theme-git .file-icon { 
            fill: #8b949e; 
        }
        .theme-git #note-preview-header { 
            background-color: #161b22; 
            color: #c9d1d9; 
        }
        .theme-git input[type="text"], 
        .theme-git select { 
            background-color: #0d1117; 
            border: 1px solid #30363d; 
            color: #c9d1d9; 
        }
        .theme-git input[type="text"]:focus, 
        .theme-git select:focus { 
            border-color: #1f6feb; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(31,111,235,0.3); 
        }
        .theme-git .io-warning { 
            color: #8b949e; 
        }
        .theme-git .modal-content .window-body { 
            background-color: #0d1117; 
            color: #c9d1d9; 
        }
        .theme-git #file-manager-back-btn { 
            display: none; 
        }
        /* Show back button for Git theme like mobile themes */
        .theme-git #file-manager-window #file-manager-back-btn {
            display: flex !important;
            align-items: center;
            justify-content: center;
            padding: 5px 16px;
            margin-right: 8px;
            border-radius: 6px;
            background-color: #238636;
            color: white;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.2s;
            position: relative;
            z-index: 2;
            border: 1px solid rgba(240,246,252,0.1);
        }
        .theme-git #file-manager-window #file-manager-back-btn:hover {
            background-color: #2ea043;
        }
        .theme-git #file-manager-window #file-manager-back-btn svg {
            width: 16px;
            height: 16px;
            margin-right: 6px;
            fill: white;
        }
        
        /* Git theme checklist styles */
        .theme-git #checklist-container {
            background: #161b22;
            border-color: #30363d;
        }
        .theme-git .checklist-item {
            background: rgba(33,38,45,0.5);
        }
        .theme-git .checklist-text {
            color: #c9d1d9; /* Match Git theme text color */
        }
        .theme-git #checklist-input,
        .theme-git .checklist-edit-input {
            background-color: #0d1117;
            border-color: #30363d;
            color: #c9d1d9;
        }
        .theme-git .checklist-close-btn,
        .theme-git .checklist-edit-btn {
            background-color: #238636;
            color: white;
            border: 1px solid rgba(240,246,252,0.1);
        }
        .theme-git .checklist-close-btn:hover,
        .theme-git .checklist-edit-btn:hover {
            background-color: #2ea043;
        }

        /* --- Android Theme (Dark) --- */
        .theme-android body { background-color: #121212; font-family: 'Roboto', sans-serif; }
        .theme-android #app-window, .theme-android .modal-content, .theme-android #file-manager-window { background-color: #1e1e1e; border: 1px solid #333; border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .theme-android .title-bar { 
            background: #2c2c2c; 
            padding: 12px 16px; 
            color: #e0e0e0; 
            font-weight: 500; 
            height: auto; 
            border-bottom: 1px solid #333; 
        }
        .theme-android .title-bar-text { 
            font-size: 18px; 
            padding: 0 80px; 
            color: #e0e0e0;
        }
        .theme-android #file-manager-window .title-bar-text {
            left: 50px;
            right: 50px;
            padding: 0;
        }
        .theme-android .menu-bar { display: flex; flex-wrap: wrap; justify-content: flex-end; list-style: none; margin: 0; padding: 8px; background: #2c2c2c; gap: 4px; border-bottom: 1px solid #333; }
        .theme-android .menu-bar > li { padding: 6px 10px; font-size: 13px; border-radius: 20px; border: 1px solid #555; background: #3c3c3c; box-shadow: none; color: #e0e0e0; cursor: pointer; }
        .theme-android .menu-bar > li:hover { background: #555; }
        .theme-android .window-body { padding: 0; box-shadow: none; background-color: #1e1e1e; }
        .theme-android #editor, .theme-android #note-preview { background-color: #1e1e1e; border: none; font-family: 'Roboto', sans-serif; font-size: 16px; padding: 16px; line-height: 1.6; color: #e0e0e0; }
        .theme-android button, .theme-android select, .theme-android input[type="text"] { font-family: 'Roboto', sans-serif; font-size: 14px; border: 1px solid #444; background-color: #2c2c2c; color: #fff; border-radius: 8px; padding: 10px 14px; min-height: 40px; }
        .theme-android button { background-color: #8ab4f8; color: #202124; border: none; font-weight: 500; }
        .theme-android button:active { background-color: #7aa3e6; }
        .theme-android button.primary { background-color: #81c995; color: #202124; }
        .theme-android button.primary:active { background-color: #70b884; }
        .theme-android .title-bar-controls { display: none; }
        .theme-android .dropdown-content { border: 1px solid #333; border-radius: 8px; background-color: #1e1e1e; box-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .theme-android .dropdown-content li { color: #e0e0e0; border-bottom: 1px solid #333; }
        .theme-android .dropdown-content li:hover { background: #3c3c3c; }
        .theme-android #about-modal p { color: #fff; }
        .theme-android #notes-list-container, .theme-android .notes-list-header, .theme-android .note-item, .theme-android #note-preview-header { border-color: #333; background-color: #2c2c2c; }
        .theme-android .notes-list-header { background-color: #2c2c2c; }
        .theme-android .note-item { background-color: #2c2c2c; }
        .theme-android .note-item.active { background-color: #8ab4f8; color: #202124; }
        .theme-android .note-item.active .file-icon { fill: #202124; }
        .theme-android .file-icon { fill: #9aa0a6; }
        .theme-android #file-manager-window .title-bar { justify-content: flex-start; gap: 8px; }
        .theme-android #file-manager-window .title-bar-controls { display: none; }
        /* Android Back Button Styling */
        .theme-android #file-manager-back-btn {
            display: flex !important;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            margin-right: 8px;
            border-radius: 20px;
            background-color: #8ab4f8;
            color: #202124;
            font-weight: 500;
            font-size: 14px;
            text-transform: uppercase;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            transition: all 0.3s cubic-bezier(.25,.8,.25,1);
            position: relative;
            z-index: 2;
        }
        .theme-android #file-manager-back-btn:hover {
            background-color: #7aa3e6;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
        }
        .theme-android #file-manager-back-btn svg {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            fill: #202124;
        }

        /* --- Dark Mode Overrides --- */
        body.dark-mode { background-color: #121212; }
        .dark-mode #app-window, .dark-mode .modal-content, .dark-mode #file-manager-window, .dark-mode .dropdown-content { background-color: #1e1e1e; color: #e0e0e0; }
        .dark-mode #font-size-modal .modal-content { background-color: #1e1e1e; }
        .dark-mode .title-bar { background: #2c2c2c; color: #e0e0e0; border-bottom-color: #3c3c3c; }
        .dark-mode .menu-bar { background: #2c2c2c; border-bottom-color: #3c3c3c; }
        .dark-mode .menu-bar > li { background: #3c3c3c; color: #e0e0e0; border-color: #555; }
        .dark-mode .menu-bar > li:hover { background: #555; }
        .dark-mode #editor, .dark-mode #note-preview, .dark-mode input, .dark-mode select { background-color: #2c2c2c; color: #e0e0e0; border-color: #555; }
        .dark-mode button { background-color: #007aff; color: #fff; }
        .dark-mode button:active { background-color: #005bb5; }
        .dark-mode .dropdown-content li { color: #e0e0e0; border-bottom-color: #3c3c3c; }
        .dark-mode .dropdown-content li:hover { background: #3c3c3c; }
        .dark-mode .note-item { border-bottom-color: #3c3c3c; }
        .dark-mode .note-item.active { background-color: #007aff; color: #fff; }
        .dark-mode .file-icon { fill: #e0e0e0; }
        .dark-mode .note-item.active .file-icon { fill: #fff; }
        
        /* Dark Mode Checklist Styles */
        .dark-mode #checklist-container {
            background: #2c2c2c;
            border-color: #555;
        }
        .dark-mode .checklist-item {
            background: rgba(255,255,255,0.05);
        }
        .dark-mode #checklist-input {
            background-color: #3c3c3c;
            border-color: #555;
            color: #e0e0e0;
        }
        .dark-mode .checklist-close-btn,
        .dark-mode .checklist-edit-btn {
            background-color: #007aff;
        }
        .dark-mode .checklist-close-btn:hover,
        .dark-mode .checklist-edit-btn:hover {
            background-color: #005bb5;
        }
        
        /* Dark mode for iOS - Fixed popup backgrounds */
        .dark-mode.theme-ios #app-window, 
        .dark-mode.theme-ios .modal-content, 
        .dark-mode.theme-ios #file-manager-window { 
            background-color: #1c1c1e; 
            border-color: #333; 
        }
        .dark-mode.theme-ios .modal-content .window-body,
        .dark-mode.theme-ios #file-manager-window .window-body {
            background-color: #1c1c1e !important;
        }
        .dark-mode.theme-ios .title-bar, 
        .dark-mode.theme-ios .menu-bar { 
            background: #1c1c1e; 
            border-bottom-color: #333; 
        }
        .dark-mode.theme-ios .title-bar-text, 
        .dark-mode.theme-ios p { 
            color: #fff; 
        }
        .dark-mode.theme-ios .menu-bar > li { 
            color: #0a84ff; 
        }
        .dark-mode.theme-ios .menu-bar > li:hover { 
            background: #2c2c2e; 
        }
        .dark-mode.theme-ios #editor, 
        .dark-mode.theme-ios #note-preview, 
        .dark-mode.theme-ios input, 
        .dark-mode.theme-ios select { 
            background-color: #1c1c1e; 
            color: #fff; 
            border-color: #333; 
        }
        .dark-mode.theme-ios .dropdown-content { 
            background-color: #1c1c1e !important;
            border-color: #333 !important;
        }
        .dark-mode.theme-ios .dropdown-content li { 
            color: #0a84ff; 
            border-bottom-color: #333; 
        }
        .dark-mode.theme-ios .dropdown-content li:hover { 
            background: #2c2c2e; 
        }
        .dark-mode.theme-ios #about-modal p { 
            color: #fff; 
        }
        .dark-mode.theme-ios #font-size-modal .modal-content { 
            background-color: #1c1c1e; 
        }
        .dark-mode.theme-ios #file-manager-window .window-body { 
            background-color: #1c1c1e; 
        }
        .dark-mode.theme-ios .note-item.active { 
            background-color: #0a84ff; 
        }
        .dark-mode.theme-ios .notes-list-header {
            background-color: #1c1c1e;
            border-color: #333;
        }
        .dark-mode.theme-ios #notes-list-container {
            background-color: #1c1c1e;
        }
        .dark-mode.theme-ios button {
            background-color: #0a84ff;
        }
        .dark-mode.theme-ios button.primary {
            background-color: #30d158;
        }
        .dark-mode.theme-ios input[type="text"],
        .dark-mode.theme-ios select {
            background-color: #2c2c2c !important;
            color: #fff !important;
            border-color: #444 !important;
        }

        /* Dark mode for Android - Fixed popup backgrounds */
        .dark-mode.theme-android body { 
            background-color: #121212; 
        }
        .dark-mode.theme-android #app-window, 
        .dark-mode.theme-android .modal-content, 
        .dark-mode.theme-android #file-manager-window { 
            background-color: #1e1e1e; 
            border-color: #333; 
        }
        .dark-mode.theme-android .modal-content .window-body,
        .dark-mode.theme-android #file-manager-window .window-body {
            background-color: #1e1e1e !important;
        }
        .dark-mode.theme-android .title-bar, 
        .dark-mode.theme-android .menu-bar { 
            background: #2c2c2c; 
            border-bottom-color: #333; 
        }
        .dark-mode.theme-android .title-bar-text, 
        .dark-mode.theme-android p { 
            color: #e0e0e0; 
        }
        .dark-mode.theme-android .menu-bar > li { 
            background: #3c3c3c; 
            color: #e0e0e0; 
            border-color: #555; 
        }
        .dark-mode.theme-android .menu-bar > li:hover { 
            background: #555; 
        }
        .dark-mode.theme-android .dropdown-content { 
            background-color: #1e1e1e !important;
            border-color: #333 !important;
        }
        .dark-mode.theme-android .dropdown-content li { 
            color: #e0e0e0; 
            border-bottom-color: #333; 
        }
        .dark-mode.theme-android .dropdown-content li:hover { 
            background: #3c3c3c; 
        }
        .dark-mode.theme-android #about-modal p { 
            color: #fff; 
        }
        .dark-mode.theme-android #font-size-modal .modal-content { 
            background-color: #1e1e1e; 
        }
        .dark-mode.theme-android #file-manager-window .window-body { 
            background-color: #1e1e1e; 
        }
        .dark-mode.theme-android .note-item.active { 
            background-color: #8ab4f8; 
            color: #202124; 
        }
        .dark-mode.theme-android .note-item.active .file-icon { 
            fill: #202124; 
        }
        .dark-mode.theme-android .notes-list-header {
            background-color: #2c2c2c;
            border-color: #333;
        }
        .dark-mode.theme-android #notes-list-container {
            background-color: #2c2c2c;
        }
        .dark-mode.theme-android button {
            background-color: #8ab4f8;
            color: #202124;
        }
        .dark-mode.theme-android button.primary {
            background-color: #81c995;
        }
        .dark-mode.theme-android input[type="text"],
        .dark-mode.theme-android select {
            background-color: #2c2c2c !important;
            color: #fff !important;
            border-color: #444 !important;
        }

        /* --- FIX: Dark Mode Input Boxes --- */
        .dark-mode.theme-win95 input[type="text"],
        .dark-mode.theme-win95 select,
        .dark-mode.theme-winxp input[type="text"],
        .dark-mode.theme-winxp select {
            background-color: #2c2c2c;
            color: #e0e0e0;
            border: 1px solid #555;
            box-shadow: none;
            background-image: none;
        }
    </style>

</head>
<body class="theme-android">
<div id="app-window">
    <div class="title-bar">
        <div class="title-bar-text">AFSNote</div>
        <div class="title-bar-controls">
            <button id="minimize-btn" class="win-button" aria-label="Minimize"><span class="icon minimize-icon"></span></button>
            <button id="maximize-btn" class="win-button" aria-label="Maximize"><span class="icon maximize-icon"></span></button>
            <button id="close-btn" class="win-button" aria-label="Close"><span class="icon close-icon">Ã—</span></button>
        </div>
    </div>
    <ul class="menu-bar">
        <li class="menu-item">
            File
            <ul class="dropdown-content">
                <li id="new-file-btn">New Note</li>
                <li id="open-file-btn">Open from Device...</li>
                <li id="save-note-btn">Save Note</li>
                <li id="save-to-device-btn">Save to Device...</li>
            </ul>
        </li>
        <li id="saved-notes-btn">Saved Notes</li>
        <li class="menu-item menu-item-right">
            Styles
            <ul class="dropdown-content">
                <li id="theme-win95-btn">Windows 95</li>
                <li id="theme-winxp-btn">Windows XP</li>
                <li id="theme-ios-btn">iOS</li>
                <li id="theme-android-btn">Android</li>
                <li id="theme-git-btn">Git</li>
            </ul>
        </li>
        <li class="menu-item menu-item-right">
            Tools
            <ul class="dropdown-content">
                <li id="font-size-menu-btn">Font Size</li>
                <li id="replace-menu-btn">Replace</li>
                <li id="import-export-btn">Import/Export</li>
                <li id="about-menu-btn">About</li>
            </ul>
        </li>
    </ul>
    <div class="window-body">
        <div id="checklist-container" style="display: none;">
            <div class="checklist-items" id="checklist-items"></div>
            <div id="checklist-input-container">
                <input type="text" id="checklist-input" placeholder="Add item..." />
            </div>
            <div class="checklist-controls">
                <button class="checklist-close-btn" id="checklist-close">Close</button>
                <button class="checklist-edit-btn" id="checklist-edit" style="display: none;">Edit</button>
            </div>
        </div>
        <textarea id="editor" spellcheck="false"></textarea>
    </div>
</div>

<div id="about-modal" class="modal">
    <div class="modal-content">
        <div class="title-bar">
            <div class="title-bar-text">About AFSNote</div>
            <div class="version-display">[Version 1.0.0]</div>
        </div>
        <div class="window-body">
            <p style="text-align: center; margin: 20px; font-weight: bold;">
                This shitty app was vibe coded by <br>an absolute complete dumbass
                who was sick <br>of all your shitty note apps.
                <br><br>
                Like who the fuck wants a note taking app <br>to open DIRECTLY
                to the saved notes, <br>showing you every single note <br>with just
                enough of a snippet to raise suspicion, <br>get better you fucking weirdos.
            </p>
            <p style="text-align: center; margin: 20px; font-weight: bold;">
                Your notes are stored locally in your browser,<br>
                so it's your fault if you lose them, dumbass.
            </p>
            <section class="field-row"><button id="close-modal-1">Close</button></section>
        </div>
    </div>
</div>

<div id="save-note-modal" class="modal">
     <div class="modal-content">
        <div class="title-bar"><div class="title-bar-text">Save Note</div></div>
        <div class="window-body">
            <label for="note-name-input" style="display: block; margin-bottom: 8px;">Note Name:</label>
            <input type="text" id="note-name-input" value="">
            <section class="field-row"><button id="cancel-note-save-btn">Cancel</button><button id="confirm-note-save-btn" class="primary">Save</button></section>
        </div>
    </div>
</div>

<div id="save-to-device-modal" class="modal">
     <div class="modal-content">
        <div class="title-bar"><div class="title-bar-text">Save to Device</div></div>
        <div class="window-body">
            <label for="device-filename-input" style="display: block; margin-bottom: 8px;">File Name:</label>
            <input type="text" id="device-filename-input" value="" placeholder="filename.txt">
            <label for="file-type-select" style="display: block; margin-top: 10px; margin-bottom: 8px;">File Type:</label>
            <select id="file-type-select">
                <option value="txt">.txt (Text File)</option>
                <option value="html">.html (HTML File)</option>
            </select>
            <section class="field-row"><button id="cancel-device-save-btn">Cancel</button><button id="confirm-device-save-btn" class="primary">Save</button></section>
        </div>
    </div>
</div>

<div id="font-size-modal" class="modal">
     <div class="modal-content">
       <div class="title-bar"><div class="title-bar-text">Adjust Font Size</div></div>
       <div class="window-body">
            <input type="range" id="font-size-slider" min="8" max="48" value="16">
            <p id="font-size-display">16px</p>
            <section class="field-row"><button id="close-font-modal-btn">Close</button></section>
       </div>
   </div>
</div>

<div id="replace-modal" class="modal">
    <div class="modal-content">
        <div class="title-bar"><div class="title-bar-text">Replace</div></div>
        <div class="window-body">
            <label for="find-input">Find:</label>
            <input type="text" id="find-input">
            <label for="replace-input" style="margin-top: 10px;">Replace with:</label>
            <input type="text" id="replace-input">
            <section class="field-row">
                <button id="confirm-replace-all-btn">Replace All</button>
                <button id="close-replace-btn">Close</button>
            </section>
        </div>
    </div>
</div>

<div id="import-export-modal" class="modal">
    <div class="modal-content">
        <div class="title-bar"><div class="title-bar-text">Import/Export Notes</div></div>
        <div class="window-body">
            <div class="io-section">
                <button id="import-notes-btn">ðŸ“¥</button>
                <p>Import Notes</p>
            </div>
            <div class="io-section">
                <button id="export-notes-btn">ðŸ“¤</button>
                <p>Export Notes</p>
            </div>
            <p class="io-warning">Note: Your notes are stored locally in your browser.</p>
        </div>
        <section class="field-row">
            <button id="close-io-modal-btn">Close</button>
        </section>
    </div>
</div>

<div id="delete-confirm-modal" class="modal">
    <div class="modal-content">
        <div class="title-bar"><div class="title-bar-text">Confirm Deletion</div></div>
        <div class="window-body">
            <p style="text-align: center; margin: 20px;">Are you sure you want to delete this note?</p>
            <section class="field-row">
                <button id="cancel-delete-btn">No</button>
                <button id="confirm-delete-btn" class="primary">Yes</button>
            </section>
        </div>
    </div>
</div>

<input type="file" id="file-opener" accept=".txt,text/plain">
<input type="file" id="import-file-opener" accept=".json,application/json">

<div id="file-manager-window">
    <div class="title-bar">
        <button id="file-manager-back-btn">
            <svg viewBox="0 0 24 24" width="20" height="20">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Back
        </button>
        <div class="title-bar-text">Saved Notes</div>
        <div class="title-bar-controls">
            <button id="file-manager-close-btn" class="win-button" aria-label="Close"><span class="icon close-icon">Ã—</span></button>
        </div>
    </div>
    <div class="window-body">
         <div id="file-manager-content">
            <div id="notes-list-container">
                <div class="notes-list-header">
                    <span class="header-name">Name</span>
                    <div class="menu-item">
                        <button id="filter-btn">Filter</button>
                        <ul class="dropdown-content">
                            <li data-sort="name-asc">Name (A-Z)</li>
                            <li data-sort="name-desc">Name (Z-A)</li>
                            <li data-sort="date-desc">Newest First</li>
                            <li data-sort="date-asc">Oldest First</li>
                        </ul>
                    </div>
                </div>
                <div id="notes-list"></div>
            </div>
            <div id="note-preview-container">
                <div id="note-preview-header">
                    <div>
                        <div id="note-preview-title"></div>
                        <div id="note-preview-date"></div>
                    </div>
                    <div id="note-preview-actions">
                        <button id="preview-open-btn">Open in Editor</button>
                        <button id="preview-delete-btn">Delete</button>
                    </div>
                </div>
                <div id="note-preview">Select a note to preview...</div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const getEl = id => document.getElementById(id);
        
        // --- State ---
        let currentNoteId = null;
        let selectedPreviewId = null;
        let isDirty = false; // Flag for unsaved changes
        let autosaveTimeout = null; // Timer for autosave
        let checklistMode = false;
        let checklistItems = [];
        
        // --- Element Cache ---
        const editor = getEl('editor');
        const fileOpener = getEl('file-opener');
        const importFileOpener = getEl('import-file-opener');
        const closeBtn = getEl('close-btn');
        const titleBarText = document.querySelector('#app-window .title-bar-text');
        
        // Menu Buttons
        const newFileBtn = getEl('new-file-btn');
        const openFileBtn = getEl('open-file-btn');
        const saveNoteBtn = getEl('save-note-btn');
        const saveToDeviceBtn = getEl('save-to-device-btn');
        const aboutMenuBtn = getEl('about-menu-btn');
        const fontSizeMenuBtn = getEl('font-size-menu-btn');
        const savedNotesBtn = getEl('saved-notes-btn');
        const replaceMenuBtn = getEl('replace-menu-btn');
        const importExportBtn = getEl('import-export-btn');
        const fontSizeSlider = getEl('font-size-slider');
        const fontSizeDisplay = getEl('font-size-display');
        const fileTypeSelect = getEl('file-type-select');
        const deviceFilenameInput = getEl('device-filename-input');
        
        // Checklist Elements
        const checklistContainer = getEl('checklist-container');
        const checklistItemsContainer = getEl('checklist-items');
        const checklistInput = getEl('checklist-input');
        const checklistClose = getEl('checklist-close');
        const checklistEdit = getEl('checklist-edit');
        
        // --- Title Bar Logic ---
        const updateTitleBar = (noteName, showSavedMessage = false) => {
            let displayName = noteName || 'Untitled';
            if (displayName.length > 15) {
                displayName = displayName.substring(0, 15) + '...';
            }
            const baseTitle = `${displayName} - AFSNote`;
            titleBarText.textContent = baseTitle;
            if (showSavedMessage) {
                titleBarText.textContent = `âœ“ Saved - ${displayName} - AFSNote`;
                setTimeout(() => {
                    if (titleBarText.textContent.startsWith('âœ“ Saved')) {
                        titleBarText.textContent = baseTitle;
                    }
                }, 1500);
            }
        };

        // --- Checklist Feature Logic ---
        const enterChecklistMode = () => {
            checklistMode = true;
            editor.style.display = 'none';
            checklistContainer.style.display = 'flex';
            checklistInput.focus();
            checklistClose.style.display = 'block';
            checklistEdit.style.display = 'none';
        };
        
        const exitChecklistMode = () => {
            checklistMode = false;
            checklistContainer.style.display = 'none';
            editor.style.display = 'block';
            
            // Convert checklist back to text
            let text = '';
            checklistItems.forEach(item => {
                const checkbox = item.completed ? '[x]' : '[ ]';
                text += `${checkbox} ${item.text}\n`;
            });
            
            // Replace the !list command with the actual checklist content
            const lines = editor.value.split('\n');
            const listIndex = lines.findIndex(line => line.trim() === '!list');
            if (listIndex !== -1) {
                lines[listIndex] = text.trim();
                editor.value = lines.join('\n');
            } else {
                // If !list not found, just append the checklist content
                editor.value = editor.value + '\n' + text;
            }
            
            // Clear checklist items for next use
            checklistItems = [];
        };
        
        const addChecklistItem = (text) => {
            const itemId = Date.now();
            const item = { id: itemId, text: text, completed: false };
            checklistItems.push(item);
            renderChecklistItems();
            // Autosave when new item is added
            autosaveChecklist();
        };
        
        // Helper function to autosave checklist
        const autosaveChecklist = () => {
            if (checklistMode && currentNoteId) {
                const notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    saveNoteToLocalStorage(note.name, true);
                }
            }
        };
        
        const renderChecklistItems = () => {
            checklistItemsContainer.innerHTML = '';
            checklistItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'checklist-item';
                if (item.completed) itemDiv.classList.add('completed');
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'checklist-checkbox';
                checkbox.checked = item.completed;
                checkbox.addEventListener('change', () => {
                    item.completed = checkbox.checked;
                    if (checkbox.checked) {
                        itemDiv.classList.add('completed');
                    } else {
                        itemDiv.classList.remove('completed');
                    }
                    // Autosave when item is checked/unchecked
                    autosaveChecklist();
                });
                
                const textSpan = document.createElement('span');
                textSpan.className = 'checklist-text';
                textSpan.textContent = item.text;
                
                // Create edit input (hidden by default)
                const editInput = document.createElement('input');
                editInput.type = 'text';
                editInput.className = 'checklist-edit-input';
                editInput.value = item.text;
                
                // Double-click to edit
                textSpan.addEventListener('dblclick', () => {
                    itemDiv.classList.add('editing');
                    editInput.value = item.text;
                    editInput.focus();
                    editInput.select();
                });
                
                // Save on Enter, cancel on Escape
                editInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const newText = editInput.value.trim();
                        if (newText) {
                            item.text = newText;
                            textSpan.textContent = newText;
                            // Autosave when item is edited
                            autosaveChecklist();
                        }
                        itemDiv.classList.remove('editing');
                    } else if (e.key === 'Escape') {
                        editInput.value = item.text;
                        itemDiv.classList.remove('editing');
                    }
                });
                
                // Save on blur
                editInput.addEventListener('blur', () => {
                    const newText = editInput.value.trim();
                    if (newText && newText !== item.text) {
                        item.text = newText;
                        textSpan.textContent = newText;
                        // Autosave when item is edited
                        autosaveChecklist();
                    }
                    itemDiv.classList.remove('editing');
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'checklist-delete';
                deleteBtn.textContent = 'Delete';
                deleteBtn.addEventListener('click', () => {
                    checklistItems = checklistItems.filter(i => i.id !== item.id);
                    renderChecklistItems();
                    // Autosave when item is deleted
                    autosaveChecklist();
                });
                
                // Long press for delete
                let pressTimer;
                const startPress = () => {
                    pressTimer = setTimeout(() => {
                        deleteBtn.classList.add('show');
                        setTimeout(() => {
                            deleteBtn.classList.remove('show');
                        }, 3000);
                    }, 1000);
                };
                
                const cancelPress = () => {
                    clearTimeout(pressTimer);
                };
                
                itemDiv.addEventListener('mousedown', (e) => {
                    if (!e.target.matches('input')) startPress();
                });
                itemDiv.addEventListener('touchstart', (e) => {
                    if (!e.target.matches('input')) startPress();
                });
                itemDiv.addEventListener('mouseup', cancelPress);
                itemDiv.addEventListener('mouseleave', cancelPress);
                itemDiv.addEventListener('touchend', cancelPress);
                
                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(textSpan);
                itemDiv.appendChild(editInput);
                itemDiv.appendChild(deleteBtn);
                checklistItemsContainer.appendChild(itemDiv);
            });
        };
        
        // Checklist event listeners
        checklistInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && checklistInput.value.trim()) {
                addChecklistItem(checklistInput.value.trim());
                checklistInput.value = '';
            }
        });
        
        checklistClose.addEventListener('click', () => {
            checklistInput.style.display = 'none';
            checklistClose.style.display = 'none';
            checklistEdit.style.display = 'block';
        });
        
        checklistEdit.addEventListener('click', () => {
            checklistInput.style.display = 'block';
            checklistEdit.style.display = 'none';
            checklistClose.style.display = 'block';
            checklistInput.focus();
        });
        
        // Monitor editor for !list command
        editor.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const lines = editor.value.split('\n');
                const currentLine = lines[lines.length - 1];
                if (currentLine.trim() === '!list') {
                    e.preventDefault();
                    checklistItems = [];
                    
                    // Create a new note ID if we don't have one
                    if (!currentNoteId) {
                        currentNoteId = Date.now();
                        // Save initially as "Untitled" checklist
                        const notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
                        const note = { 
                            id: currentNoteId, 
                            name: 'Untitled Checklist', 
                            content: '', 
                            createdAt: Date.now() 
                        };
                        notes.unshift(note);
                        localStorage.setItem('afsnote_notes', JSON.stringify(notes));
                        updateTitleBar('Untitled Checklist');
                    }
                    
                    enterChecklistMode();
                }
            }
        });

        // --- Theme Switcher Logic ---
        const closeAllDropdowns = () => {
            document.querySelectorAll('.dropdown-content').forEach(d => d.style.display = 'none');
        };

        // Setup dropdown menus
        document.querySelectorAll('.menu-item').forEach(item => {
            const hasDropdown = item.querySelector('.dropdown-content');
            
            item.addEventListener('click', event => {
                if (hasDropdown && event.target.closest('.dropdown-content')) {
                    return;
                }
                event.stopPropagation();
                
                if (hasDropdown) {
                    const dropdown = item.querySelector('.dropdown-content');
                    const isVisible = dropdown.style.display === 'block';
                    closeAllDropdowns();
                    if (!isVisible) {
                        dropdown.style.display = 'block';
                    }
                } else {
                    closeAllDropdowns();
                }
            });
        });
        
        document.querySelectorAll('.dropdown-content li').forEach(item => {
            item.addEventListener('click', (e) => {
                e.stopPropagation();
                closeAllDropdowns();
            });
        });
        
        window.addEventListener('click', closeAllDropdowns);
        
        const setTheme = (theme) => {
            document.body.className = theme;
            localStorage.setItem('afsnote_theme', theme);
        };

        getEl('theme-win95-btn').addEventListener('click', () => setTheme('theme-win95'));
        getEl('theme-winxp-btn').addEventListener('click', () => setTheme('theme-winxp'));
        getEl('theme-ios-btn').addEventListener('click', () => setTheme('theme-ios'));
        getEl('theme-android-btn').addEventListener('click', () => setTheme('theme-android'));
        getEl('theme-git-btn').addEventListener('click', () => setTheme('theme-git'));
        const savedTheme = localStorage.getItem('afsnote_theme') || 'theme-android';
        setTheme(savedTheme);

        // --- Core App Logic ---
        closeBtn.addEventListener('click', () => { window.close(); });
        newFileBtn.addEventListener('click', () => {
            editor.value = '';
            currentNoteId = null;
            isDirty = false;
            updateTitleBar('Untitled');
            if (checklistMode) exitChecklistMode();
        });
        openFileBtn.addEventListener('click', () => { fileOpener.click(); });
        fileOpener.addEventListener('change', event => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => { editor.value = e.target.result; };
            reader.readAsText(file);
            event.target.value = null; 
            currentNoteId = null;
            isDirty = false;
            updateTitleBar(file.name.replace(/\.[^/.]+$/, ""));
        });
        
        // --- Save Note (Local Storage) Logic ---
        const saveNoteToLocalStorage = (name, isAutosave = false) => {
            let notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
            let noteName = name.trim() || 'Untitled';
            let savedNoteName = noteName;
            let content = '';

            // If in checklist mode, convert items to text format for storage
            if (checklistMode) {
                let checklistText = '';
                checklistItems.forEach(item => {
                    const checkbox = item.completed ? '[x]' : '[ ]';
                    checklistText += `${checkbox} ${item.text}\n`;
                });
                // Combine any text in editor with checklist items
                const editorText = editor.value.trim();
                content = editorText ? editorText + '\n' + checklistText : checklistText;
            } else {
                content = editor.value;
            }

            if (currentNoteId) {
                const note = notes.find(n => n.id === currentNoteId);
                if (note) {
                    note.content = content;
                    note.createdAt = Date.now();
                    note.name = noteName;
                    savedNoteName = note.name;
                }
            } else {
                const note = { id: Date.now(), name: noteName, content: content, createdAt: Date.now() };
                notes.unshift(note);
                currentNoteId = note.id;
                savedNoteName = note.name;
            }
            localStorage.setItem('afsnote_notes', JSON.stringify(notes));
            isDirty = false;
            
            if (isAutosave) {
                updateTitleBar(savedNoteName, true);
            } else {
                updateTitleBar(savedNoteName);
            }
            
            // Stay in checklist mode after saving
            // Don't call exitChecklistMode()
        };
        const saveNoteModal = getEl('save-note-modal');
        saveNoteBtn.addEventListener('click', () => {
            if (currentNoteId) {
                const notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
                const note = notes.find(n => n.id === currentNoteId);
                saveNoteToLocalStorage(note.name);
                alert('Note updated!');
            } else {
                saveNoteModal.style.display = 'flex';
                getEl('note-name-input').focus();
            }
        });
        getEl('cancel-note-save-btn').addEventListener('click', () => { saveNoteModal.style.display = 'none'; });
        getEl('confirm-note-save-btn').addEventListener('click', () => {
            saveNoteToLocalStorage(getEl('note-name-input').value);
            saveNoteModal.style.display = 'none';
        });

        // --- Save to Device Logic ---
        const saveToDeviceModal = getEl('save-to-device-modal');
        const saveToDevice = (filename, type) => {
            let finalFilename = filename.trim() || 'Untitled';
            let content = editor.value;
            let mimeType = 'text/plain';
            
            // Remove extension if already present
            finalFilename = finalFilename.replace(/\.(txt|html)$/i, '');
            
            // Add appropriate extension and set MIME type
            if (type === 'html') {
                finalFilename += '.html';
                mimeType = 'text/html';
                // Ensure basic HTML structure if saving as HTML
                if (!content.includes('<html') && !content.includes('<HTML')) {
                    content = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${finalFilename.replace('.html', '')}</title>
</head>
<body>
${content}
</body>
</html>`;
                }
            } else {
                finalFilename += '.txt';
            }

            try {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = finalFilename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 100);
            } catch (err) {
                alert(`Error saving file: ${err.message}`);
            }
        };

        saveToDeviceBtn.addEventListener('click', () => {
            saveToDeviceModal.style.display = 'flex';
            getEl('device-filename-input').focus();
            getEl('device-filename-input').value = ''; // Clear previous input
        });
        getEl('cancel-device-save-btn').addEventListener('click', () => { saveToDeviceModal.style.display = 'none'; });
        getEl('confirm-device-save-btn').addEventListener('click', () => {
            const filename = getEl('device-filename-input').value;
            const type = getEl('file-type-select').value;
            saveToDevice(filename, type);
            saveToDeviceModal.style.display = 'none';
        });

        // --- Other Modals ---
        const aboutModal = getEl('about-modal');
        aboutMenuBtn.addEventListener('click', () => { aboutModal.style.display = 'flex'; });
        getEl('close-modal-1').addEventListener('click', () => aboutModal.style.display = 'none');
        
        const fontSizeModal = getEl('font-size-modal');
        fontSizeMenuBtn.addEventListener('click', () => { 
            const currentSize = parseInt(editor.style.fontSize) || 16;
            fontSizeSlider.value = currentSize;
            fontSizeDisplay.textContent = `${currentSize}px`;
            fontSizeModal.style.display = 'flex'; 
        });
        fontSizeSlider.addEventListener('input', e => { 
            editor.style.fontSize = `${e.target.value}px`; 
            fontSizeDisplay.textContent = `${e.target.value}px`;
        });
        getEl('close-font-modal-btn').addEventListener('click', () => { fontSizeModal.style.display = 'none'; });

        // --- Replace Logic ---
        const replaceModal = getEl('replace-modal');
        const findInput = getEl('find-input');
        const replaceInput = getEl('replace-input');
        const confirmReplaceAllBtn = getEl('confirm-replace-all-btn');
        const closeReplaceBtn = getEl('close-replace-btn');
        
        const getFindRegex = (term) => {
            const escapedTerm = term.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\            <button id="file-manager-');
            const pattern = escapedTerm.length === 1 ? `\\b${escapedTerm}\\b` : escapedTerm;
            return new RegExp(pattern, 'gi');
        };
        
        replaceMenuBtn.addEventListener('click', () => {
            replaceModal.style.display = 'flex';
            findInput.focus();
        });
        
        closeReplaceBtn.addEventListener('click', () => {
            replaceModal.style.display = 'none';
        });
        
        confirmReplaceAllBtn.addEventListener('click', () => {
            const findTerm = findInput.value;
            const replaceTerm = replaceInput.value;
            if (!findTerm) {
                alert("Please enter text to find.");
                return;
            }
            const text = editor.value;
            const regex = getFindRegex(findTerm);
            if (text.match(regex)) {
                editor.value = text.replace(regex, replaceTerm);
                alert("All occurrences have been replaced.");
            } else {
                alert("Text not found.");
            }
        });
        
        // --- Import / Export Logic ---
        const ioModal = getEl('import-export-modal');
        const importBtn = getEl('import-notes-btn');
        const exportBtn = getEl('export-notes-btn');
        const closeIoModalBtn = getEl('close-io-modal-btn');
        importExportBtn.addEventListener('click', () => {
            ioModal.style.display = 'flex';
        });
        closeIoModalBtn.addEventListener('click', () => {
            ioModal.style.display = 'none';
        });
        exportBtn.addEventListener('click', () => {
            const notes = localStorage.getItem('afsnote_notes');
            if (!notes || notes === '[]') {
                alert("No notes to export.");
                return;
            }
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}${now.getSeconds().toString().padStart(2,'0')}`;
            const filename = `afsnote_export_${timestamp}.json`;
            const blob = new Blob([notes], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        importBtn.addEventListener('click', () => {
            importFileOpener.click();
        });
        importFileOpener.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    if (!Array.isArray(importedNotes)) {
                        throw new Error("Invalid JSON file: Not an array.");
                    }
                    const existingNotes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
                    const combinedNotes = [...existingNotes];
                    const existingIds = new Set(existingNotes.map(n => n.id));
                    let importCount = 0;
                    importedNotes.forEach(note => {
                        if (note.id && note.name && note.content && note.createdAt && !existingIds.has(note.id)) {
                            combinedNotes.push(note);
                            importCount++;
                        }
                    });
                    localStorage.setItem('afsnote_notes', JSON.stringify(combinedNotes));
                    alert(`${importCount} notes imported successfully.`);
                    ioModal.style.display = 'none';
                } catch (err) {
                    alert(`Error importing notes: ${err.message}`);
                }
            };
            reader.readAsText(file);
            event.target.value = null;
        });

        // --- File Manager Logic ---
        const fileManagerWindow = getEl('file-manager-window');
        const fileManagerCloseBtn = getEl('file-manager-close-btn');
        const fileManagerBackBtn = getEl('file-manager-back-btn');
        const notesList = getEl('notes-list');
        const notePreview = getEl('note-preview');
        const notePreviewTitle = getEl('note-preview-title');
        const notePreviewDate = getEl('note-preview-date');
        const previewOpenBtn = getEl('preview-open-btn');
        const previewDeleteBtn = getEl('preview-delete-btn');
        const deleteConfirmModal = getEl('delete-confirm-modal');
        const confirmDeleteBtn = getEl('confirm-delete-btn');
        const cancelDeleteBtn = getEl('cancel-delete-btn');

        const renderNotes = (sortOrder = 'date-desc') => {
            let notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
            switch(sortOrder) {
                case 'name-asc': notes.sort((a, b) => a.name.localeCompare(b.name)); break;
                case 'name-desc': notes.sort((a, b) => b.name.localeCompare(a.name)); break;
                case 'date-asc': notes.sort((a, b) => a.createdAt - b.createdAt); break;
                case 'date-desc': notes.sort((a, b) => b.createdAt - a.createdAt); break;
            }
            notesList.innerHTML = '';
            notes.forEach(note => {
                const item = document.createElement('div');
                item.className = 'note-item';
                item.dataset.noteId = note.id;
                
                const displayName = note.name.length > 15 ? note.name.substring(0, 15) + '...' : note.name;

                item.innerHTML = '<svg class="file-icon" viewBox="0 0 16 16" width="16" height="16" fill="currentColor"><path d="M4 0h8l4 4v12H0V0h4zm8 2H2v12h12V4.5L12 2zM5 8h6v1H5V8zm0 2h6v1H5v-1zm0 2h4v1H5v-1z"/></svg>' +
                    '<div class="note-item-details">' +
                        '<span class="note-item-title">' + displayName + '</span>' +
                        '<span class="note-item-date">' + new Date(note.createdAt).toLocaleString() + '</span>' +
                    '</div>';
                notesList.appendChild(item);
            });
        };
        notesList.addEventListener('click', e => {
            const noteItem = e.target.closest('.note-item');
            if (!noteItem) return;
            const notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
            const noteId = Number(noteItem.dataset.noteId);
            const note = notes.find(n => n.id === noteId);
            document.querySelectorAll('.note-item').forEach(item => item.classList.remove('active'));
            noteItem.classList.add('active');
            
            notePreviewTitle.textContent = note.name.length > 15 ? note.name.substring(0, 15) + '...' : note.name;
            notePreviewDate.textContent = new Date(note.createdAt).toLocaleString();
            
            // Check if the note content is a checklist
            const lines = note.content.split('\n');
            const isChecklist = lines.some(line => line.trim().startsWith('[ ]') || line.trim().startsWith('[x]'));
            
            if (isChecklist) {
                // Render as HTML checklist for preview
                let htmlContent = '<div style="font-family: inherit; padding: 10px;">';
                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('[ ]')) {
                        const text = trimmedLine.substring(3).trim();
                        htmlContent += `<div style="margin: 8px 0;">â˜ ${text}</div>`;
                    } else if (trimmedLine.startsWith('[x]')) {
                        const text = trimmedLine.substring(3).trim();
                        htmlContent += `<div style="margin: 8px 0; text-decoration: line-through; opacity: 0.7;">â˜‘ ${text}</div>`;
                    } else if (trimmedLine) {
                        htmlContent += `<div style="margin: 8px 0;">${trimmedLine}</div>`;
                    }
                });
                htmlContent += '</div>';
                notePreview.innerHTML = htmlContent;
            } else {
                // Regular text content
                notePreview.textContent = note.content;
            }
            
            selectedPreviewId = note.id;
        });
        previewOpenBtn.addEventListener('click', () => {
            if (!selectedPreviewId) return;
            const notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
            const note = notes.find(n => n.id === selectedPreviewId);
            
            // Check if the note is a checklist
            const lines = note.content.split('\n');
            const isChecklist = lines.some(line => line.trim().startsWith('[ ]') || line.trim().startsWith('[x]'));
            
            if (isChecklist) {
                // Parse the checklist and enter checklist mode
                checklistItems = [];
                lines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine.startsWith('[ ]')) {
                        const text = trimmedLine.substring(3).trim();
                        if (text) {
                            checklistItems.push({
                                id: Date.now() + Math.random(),
                                text: text,
                                completed: false
                            });
                        }
                    } else if (trimmedLine.startsWith('[x]')) {
                        const text = trimmedLine.substring(3).trim();
                        if (text) {
                            checklistItems.push({
                                id: Date.now() + Math.random(),
                                text: text,
                                completed: true
                            });
                        }
                    }
                });
                
                // Set the editor content without the checklist items (they'll be in the checklist UI)
                editor.value = lines.filter(line => {
                    const trimmed = line.trim();
                    return !trimmed.startsWith('[ ]') && !trimmed.startsWith('[x]');
                }).join('\n');
                
                // Enter checklist mode
                checklistMode = true;
                editor.style.display = 'none';
                checklistContainer.style.display = 'flex';
                renderChecklistItems();
                checklistInput.style.display = 'block';
                checklistClose.style.display = 'block';
                checklistEdit.style.display = 'none';
            } else {
                // Regular note - just load the content
                editor.value = note.content;
                editor.style.display = 'block';
                checklistContainer.style.display = 'none';
                checklistMode = false;
            }
            
            currentNoteId = note.id;
            isDirty = false;
            updateTitleBar(note.name);
            fileManagerWindow.style.display = 'none';
        });

        previewDeleteBtn.addEventListener('click', () => {
            if (!selectedPreviewId) return;
            deleteConfirmModal.style.display = 'flex';
        });

        cancelDeleteBtn.addEventListener('click', () => {
            deleteConfirmModal.style.display = 'none';
        });

        confirmDeleteBtn.addEventListener('click', () => {
            if (!selectedPreviewId) return;
            const notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
            const remainingNotes = notes.filter(n => n.id !== selectedPreviewId);
            localStorage.setItem('afsnote_notes', JSON.stringify(remainingNotes));
            renderNotes();
            notePreviewTitle.textContent = '';
            notePreviewDate.textContent = '';
            notePreview.textContent = 'Select a note to preview...';
            selectedPreviewId = null;
            deleteConfirmModal.style.display = 'none';
        });

        savedNotesBtn.addEventListener('click', () => {
            // Exit checklist mode if active before opening saved notes
            if (checklistMode) {
                exitChecklistMode();
            }
            renderNotes();
            notePreviewTitle.textContent = '';
            notePreviewDate.textContent = '';
            notePreview.textContent = 'Select a note to preview...';
            fileManagerWindow.style.display = 'flex';
            // Show back button for mobile themes AND Git theme
            const isMobileTheme = document.body.classList.contains('theme-ios') || 
                                  document.body.classList.contains('theme-android') || 
                                  document.body.classList.contains('theme-git');
            fileManagerBackBtn.style.display = isMobileTheme ? 'block' : 'none';
        });
        const closeFileManager = () => {
            fileManagerWindow.style.display = 'none';
        };
        fileManagerCloseBtn.addEventListener('click', closeFileManager);
        fileManagerBackBtn.addEventListener('click', closeFileManager);
        document.querySelector('#filter-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            const dropdown = document.querySelector('#filter-btn').nextElementSibling;
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        });
        document.querySelectorAll('#filter-btn + .dropdown-content li').forEach(item => {
            item.addEventListener('click', (e) => {
                renderNotes(e.target.dataset.sort);
            });
        });

        // --- Autosave & Dirty Flag Logic ---
        editor.addEventListener('input', () => {
            isDirty = true;
            clearTimeout(autosaveTimeout);
            autosaveTimeout = setTimeout(() => {
                if (currentNoteId) { // Only autosave if it's an existing note
                    const notes = JSON.parse(localStorage.getItem('afsnote_notes') || '[]');
                    const note = notes.find(n => n.id === currentNoteId);
                    if (note) {
                        saveNoteToLocalStorage(note.name, true);
                    }
                }
            }, 1500); // Wait 1.5 seconds after user stops typing
        });

        // Initialize with default title
        updateTitleBar('Untitled');
    });

    // --- Prevent Refresh on Unsaved Changes ---
    window.addEventListener('beforeunload', (e) => {
        const editor = document.getElementById('editor');
        const isDirty = editor.value && (!editor.dataset.saved || editor.dataset.saved === 'false');
        if (isDirty) {
            e.preventDefault();
            e.returnValue = '';
        }
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js').catch(err => {
                console.error('ServiceWorker registration failed: ', err);
            });
        });
    }
</script>

</body>
</html>
